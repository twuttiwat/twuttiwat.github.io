<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>From Domain to Web with Safe Stack :: TW Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Hi there. Welcome back to my F# web app development series. Just to recap for new people, we are going to create construction cost tender estimation (CoCoTender) using f#. If you are interested in the domain, you can read the past posts in the series. For this post, we wil emphasize how to connect the domain to web app using safe stack. So there is no need to understand the whole domain concept.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/safe-stack/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="From Domain to Web with Safe Stack">
<meta property="og:description" content="Hi there. Welcome back to my F# web app development series. Just to recap for new people, we are going to create construction cost tender estimation (CoCoTender) using f#. If you are interested in the domain, you can read the past posts in the series. For this post, we wil emphasize how to connect the domain to web app using safe stack. So there is no need to understand the whole domain concept.
" />
<meta property="og:url" content="http://localhost:1313/posts/safe-stack/" />
<meta property="og:site_name" content="TW Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2022-12-05 09:21:13 &#43;0700 &#43;07" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/safe-stack/">From Domain to Web with Safe Stack</a>
  </h1>
  <div class="post-meta"><time class="post-date">2022-12-05</time><span class="post-author">Teerawat Wuttiwat</span></div>

  
  


  

  <div class="post-content"><div>
        <p>Hi there. Welcome back to my F# web app development series. Just to recap for new people, we are going to create construction cost tender estimation (CoCoTender) using f#. If you are interested in the domain, you can read the <a href="../domain-modeling-with-fs/">past</a> <a href="../unit-testing-console">posts</a> in the series.
For this post, we wil emphasize how to connect the domain to web app using safe stack. So there is no need to understand the whole domain concept.</p>
<p>Let&rsquo;s kick off the process by cloning git repository I prepare for this post.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone --branch begin-safe-stack https://github.com/twuttiwat/CoCoTender.git
</span></span><span style="display:flex;"><span>cd CoCoTender
</span></span><span style="display:flex;"><span>dotnet run
</span></span></code></pre></div><p>Opening web browser at http://localhost:8080, you should see following default Todo app.</p>
<figure><img src="/posts/safe-stack/images/default-todo-app.jpg"
    alt="Default Todo App" width="600"><figcaption>
      <h4>Default Todo App</h4>
    </figcaption>
</figure>

<p>If you see this, then we are good to go now.</p>
<h1 id="use-cases">Use Cases<a href="#use-cases" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>One way to model the api is to list all of uses cases and implement each api function one by one. Here is the list of our use cases:</p>
<ol>
<li>List BoQ Items</li>
<li>Add New BoQ Item</li>
<li>Update BoQ Item</li>
<li>Delete BoQ Item</li>
<li>Calculate All Cost</li>
<li>Show FactorF Table</li>
</ol>
<p>There are previous posts mention domain modeling in the past. But for short, the ultimate goal for this CoCoTender app is to calculate the  tender cost of the project. The cost will depends on list of construction task (i.e. BoQItem). Our application should provide user interface to do CRUD operation on list of BoQItems and let the app calculate the cost and present that to client.</p>
<p>Let&rsquo;s start with our first use case</p>
<h2 id="list-boq-items">List BoQ Items<a href="#list-boq-items" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>One advantage of working with <strong>Safe Stack</strong> is the ablility to share code between server and client. The <strong>Shared</strong> module will include interface of the Api and Dto (Data Transfer Object).</p>
<p>I like to start on Shared module then Server and finally at the Client. I found that checking error on Server is much simpler than on the client.</p>
<p>Go to the bottom of the Shared.fs and declare following Dto and Api for our app.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItemDto</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Id <span style="color:#f92672">:</span> Guid
</span></span><span style="display:flex;"><span>        Description<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>        Quantity<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>        Unit<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>        Material<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>        MaterialUnitCost<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>        Labor<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>        LaborUnitCost<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>        TotalCost<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> BoQItemDto <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> create itemId description quantity <span style="color:#66d9ef">unit</span> material materialUnitCost labor laborUnitCost totalCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Id <span style="color:#f92672">=</span> itemId
</span></span><span style="display:flex;"><span>            Description <span style="color:#f92672">=</span> description
</span></span><span style="display:flex;"><span>            Quantity <span style="color:#f92672">=</span> quantity
</span></span><span style="display:flex;"><span>            Unit <span style="color:#f92672">=</span> <span style="color:#66d9ef">unit</span>
</span></span><span style="display:flex;"><span>            Material <span style="color:#f92672">=</span> material
</span></span><span style="display:flex;"><span>            MaterialUnitCost <span style="color:#f92672">=</span> materialUnitCost
</span></span><span style="display:flex;"><span>            Labor <span style="color:#f92672">=</span> labor
</span></span><span style="display:flex;"><span>            LaborUnitCost <span style="color:#f92672">=</span> laborUnitCost
</span></span><span style="display:flex;"><span>            TotalCost <span style="color:#f92672">=</span> totalCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ICoCoTenderApi</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span> getBoQItems<span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto <span style="color:#66d9ef">list</span><span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Next, go to Server.fs. We will implement the getBoQItems function.
As you can see from the signature of getBoQItems function, we will send back AsyncResult as output of the function. I think it&rsquo;s a good idea to rely on the Result, so we can be explicit about the error.</p>
<p>To make it easier to work with AsyncResult type, it&rsquo;s better to use FsErrorToolkit.ErrorHandling computation expression. I will remove a lot of matching expression when we try to extract the result from Result type.</p>
<p>Press ctrl-` and type following command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet add package FsToolkit.ErrorHandling
</span></span></code></pre></div><p>We also need to use function from our Domain library as well. So add reference to that library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet add reference ../CoCoTenderDomain
</span></span></code></pre></div><p>The default Todo app use ResizeArray as a way to store data. We will use the same approach at the moment and will change it that to some kind of database in the future.</p>
<p>add following line in module Storage</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Storage <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> boqItems <span style="color:#f92672">=</span> ResizeArray<span style="color:#f92672">&lt;</span>BoQItem<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> addBoQItem <span style="color:#f92672">(</span>boqItem<span style="color:#f92672">:</span> BoQItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        boqItems<span style="color:#f92672">.</span>Add boqItem
</span></span><span style="display:flex;"><span>        Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Tile&#34;</span><span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0 <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0 <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> defaultItem <span style="color:#f92672">=</span> BoQItem.tryCreate <span style="color:#f92672">(</span>Guid.NewGuid()<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;Pool Tile&#34;</span> qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> defaultItem <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Ok defaultItem&#39; <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            addBoQItem defaultItem&#39; <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> ()
</span></span></code></pre></div><p><strong>Note</strong> there are some issues with Library.fs in CoCoTender.Domain project. You can download the file and replace it in your project.</p>
<p>We need function to convert between Dto and Domain type. I tried to create Dto in Shared module but could not make it worked. So I decide to create the Dto conversion module in Server project instead.
Just paste following code before the webApp line</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Dto <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> toBoQItemDto <span style="color:#f92672">(</span>domain<span style="color:#f92672">:</span>BoQItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> domainVal <span style="color:#f92672">=</span>  domain <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>Quantity <span style="color:#f92672">(</span>qty<span style="color:#f92672">,</span> qtyUnit<span style="color:#f92672">))</span> <span style="color:#f92672">=</span> domainVal<span style="color:#f92672">.</span>Quantity
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>Material material<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> domainVal<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>Labor labor<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> domainVal<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>        BoQItemDto.create domainVal<span style="color:#f92672">.</span>Id domainVal<span style="color:#f92672">.</span>Description qty qtyUnit
</span></span><span style="display:flex;"><span>                            material<span style="color:#f92672">.</span>Name material<span style="color:#f92672">.</span>UnitCost labor<span style="color:#f92672">.</span>Name labor<span style="color:#f92672">.</span>UnitCost
</span></span><span style="display:flex;"><span>                            domainVal<span style="color:#f92672">.</span>TotalCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> toBoQItemDomain <span style="color:#f92672">(</span>dto<span style="color:#f92672">:</span>BoQItemDto<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>dto<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> dto<span style="color:#f92672">.</span>Unit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>Material<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>Unit<span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>MaterialUnitCost <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>Labor<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>Unit<span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> dto<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        BoQItem.tryCreate dto<span style="color:#f92672">.</span>Id dto<span style="color:#f92672">.</span>Description qty material labor
</span></span></code></pre></div><p>Finally, declare cocoTenderApi before webApp line</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> cocoTenderApi <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        getBoQItems <span style="color:#f92672">=</span> <span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> Storage.boqItems <span style="color:#f92672">|&gt;</span> List.ofSeq <span style="color:#f92672">|&gt;</span> List.map Dto.toBoQItemDto
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>and change webApp to use this new cocoTenderApi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> webApp <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.withRouteBuilder Route.builder
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.fromValue cocoTenderApi
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildHttpHandler
</span></span></code></pre></div><p>You can test if the server api work correctly by calling api directly in Chrome. Change the url to http://localhost:8080/api/ICoCoTenderApi/getBoQItems. The result should be as follow:</p>
<figure><img src="/posts/safe-stack/images/get-boq-items-response.jpg"
    alt="Response from GetBoQItems Api" width="600"><figcaption>
      <h4>GetBoQItem Response</h4>
    </figcaption>
</figure>

<p>We have finished the Server part. Next task is to render our BoQItems on the client side. Since user like to use Excel style interface, I decide to use Feliz.AgGrid component for this. We need to install it first. Go to Client project folder and install using femto.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>femto install Feliz.AgGrid
</span></span></code></pre></div><p>Open Index.fs, and start by modifying our Model type. Safe stack use Elmish for client-side programming. The only single source of state is from Model, the only place that can change the Model is from update function. The view will render the output using the states in the Model as an input.</p>
<p>Back to our Model, we need to maintain list of BoQItems to render it on the AgGrid. So define the model as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Model</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> BoQItems<span style="color:#f92672">:</span> BoQItemDto <span style="color:#66d9ef">list</span> <span style="color:#f92672">}</span> 
</span></span></code></pre></div><p>There will be 2 types of Msg to update the Model: GetBoQItems and GotBoQItems. The first one is for requesting list of BoQ Items and the second one is for receiving the list.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Msg</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GetBoQItems
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotBoQItems <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto <span style="color:#66d9ef">list</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>Replace todosApi with our cocoTenderApi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> cocoTenderApi <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.withRouteBuilder Route.builder
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildProxy<span style="color:#f92672">&lt;</span>ICoCoTenderApi<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>Initialize the Model in init fuction such that the item list will be empty at first, then the GetBoQItems will be dispatch to request list of items from the Server.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> init () <span style="color:#f92672">:</span> Model <span style="color:#f92672">*</span> Cmd<span style="color:#f92672">&lt;</span>Msg<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> model <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> BoQItems <span style="color:#f92672">=</span> [] <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.ofMsg GetBoQItems
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">,</span> cmd
</span></span></code></pre></div><p>Next implement the update function to get and receive boq items.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> update <span style="color:#f92672">(</span>msg<span style="color:#f92672">:</span> Msg<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> Model <span style="color:#f92672">*</span> Cmd<span style="color:#f92672">&lt;</span>Msg<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> msg <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GetBoQItems <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>getBoQItems () GotBoQItems
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotBoQItems <span style="color:#f92672">(</span>Ok items<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> items<span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotBoQItems <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> failwith msg
</span></span></code></pre></div><p>Since GotBoQItems response will be of type Result, then it&rsquo;s good idea to match the result at the first level.</p>
<p>Now the fun part begins. We will show the list of items using Feliz.AgGrid. I love to see the output as soon as possible, having the Hot Module Reload in Safe stack really helps in this.</p>
<p>First replace function containerBox with the new one with AgGrid.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> containerBox <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>dispatch<span style="color:#f92672">:</span> Msg <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">unit</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Html.div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        prop<span style="color:#f92672">.</span>className ThemeClass.Balham
</span></span><span style="display:flex;"><span>        prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            AgGrid.grid <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                AgGrid.rowData <span style="color:#f92672">(</span>model<span style="color:#f92672">.</span>BoQItems <span style="color:#f92672">|&gt;</span> Array.ofList<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                AgGrid.defaultColDef <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.resizable <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                AgGrid.domLayout AutoHeight
</span></span><span style="display:flex;"><span>                AgGrid.onGridReady <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>AutoSizeAllColumns()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                AgGrid.singleClickEdit <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                AgGrid.enableCellTextSelection <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                AgGrid.ensureDomOrder <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>                AgGrid.columnDefs <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Description&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Description<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Quantity&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 75
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Unit&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Unit<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 50
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Material&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Material<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 150
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;M. UnitCost&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>MaterialUnitCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 75
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Labor&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Labor<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 150
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;L. UnitCost&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>LaborUnitCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 75
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">float</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.headerName <span style="color:#e6db74">&#34;Total Cost&#34;</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>TotalCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        ColumnDef.width 75
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>The grid width will be too small. We will remove Bulma.column from Bulma.heroBody to let the container box expand to full width.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>            Bulma.heroBody <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                Bulma.container <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    Bulma.title <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        text<span style="color:#f92672">.</span>hasTextCentered
</span></span><span style="display:flex;"><span>                        prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;CoCoTender&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    containerBox model dispatch
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Here is the result of listing boq items:</p>
<figure><img src="/posts/safe-stack/images/list-boq-items.jpg"
    alt="List BoQItems" width="600"><figcaption>
      <h4>List BoQItems</h4>
    </figcaption>
</figure>

<h2 id="add-new-boq-item">Add New BoQ Item<a href="#add-new-boq-item" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>That&rsquo;s quite a lot of steps we do for the first use case. For the second one, the steps will almost be the same.</p>
<p>First we add new function to the Api in Shared.fs</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    addBoQItem<span style="color:#f92672">:</span> BoQItemDto <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span></code></pre></div><p>Second, we implement the function in Server.fs</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>        addBoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">fun</span> boqItemDto <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItemDto <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDomain
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> Storage.addBoQItem boqItem
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> boqItemDto<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> boqItem <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> boqItemDto&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Third, we implement Add functionality in the Client.</p>
<p>Add 2 more discriminated union for Msg</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddBoQItem
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddedBoQItem <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>        
</span></span></code></pre></div><p>Add 3 more cases for update function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddBoQItem <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>addBoQItem <span style="color:#f92672">(</span>defaultNewItem()<span style="color:#f92672">)</span> AddedBoQItem
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddedBoQItem <span style="color:#f92672">(</span>Ok boqItem<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>BoQItems <span style="color:#f92672">@</span> <span style="color:#f92672">[</span> boqItem <span style="color:#f92672">]</span> <span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddedBoQItem <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> failwith msg
</span></span></code></pre></div><p>See that we have new function defaultNewItem to create default new item. Just define the function before the update function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> defaultNewItem () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    BoQItemDto.create <span style="color:#f92672">(</span>Guid.NewGuid()<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;New Item&#34;</span> 0<span style="color:#f92672">.</span>0 <span style="color:#e6db74">&#34;m&#34;</span> <span style="color:#e6db74">&#34;Material 1&#34;</span>
</span></span><span style="display:flex;"><span>        0<span style="color:#f92672">.</span>0 <span style="color:#e6db74">&#34;Labor 1&#34;</span> 0<span style="color:#f92672">.</span>0 0<span style="color:#f92672">.</span>0
</span></span></code></pre></div><p>Add button before Ag.Grid</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>            Bulma.button<span style="color:#f92672">.</span>button <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                color<span style="color:#f92672">.</span>isPrimary
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>onClick <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> dispatch AddBoQItem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;Add&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            AgGrid <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Here is the result after clicking the Add button. The new boq item will be create locally, send to the server, store there and send back to client.</p>
<figure><img src="/posts/safe-stack/images/add-boq-item.jpg"
    alt="Add BoQItem" width="600"><figcaption>
      <h4>Add BoQItem</h4>
    </figcaption>
</figure>

<h2 id="update-and-delete-boq-item">Update and Delete BoQ Item<a href="#update-and-delete-boq-item" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>I think we are ready to do 2 use cases at once now.
Go to Shared.fs and add update and delete function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    updateBoQItem<span style="color:#f92672">:</span> BoQItemDto <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>    deleteBoQItem<span style="color:#f92672">:</span> Guid <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unit</span><span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>   
</span></span></code></pre></div><p>Implement these 2 functions in Server.fs. First, add 2 more functions to update and delete BoQItem from our Storage.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> updateBoQItem boqItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> boqItems<span style="color:#f92672">.</span>FindIndex<span style="color:#f92672">(</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#f92672">=</span> boqItem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        boqItems<span style="color:#f92672">[</span>index<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;-</span> boqItem
</span></span><span style="display:flex;"><span>        Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> deleteBoQItem itemId <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> boqItems<span style="color:#f92672">.</span>FindIndex<span style="color:#f92672">(</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#f92672">|&gt;</span> BoQItem.value <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> y <span style="color:#f92672">-&gt;</span> y<span style="color:#f92672">.</span>Id <span style="color:#f92672">=</span> itemId<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        boqItems<span style="color:#f92672">.</span>RemoveAt<span style="color:#f92672">(</span>index<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        Ok ()
</span></span></code></pre></div><p>Next, implement Api function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>        updateBoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">fun</span> boqItemDto <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItemDto <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDomain
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItem <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdate
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> Storage.updateBoQItem boqItem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">let</span> boqItemDto<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> boqItem <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDto
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span> boqItemDto&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        deleteBoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">fun</span> itemId <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">return</span><span style="color:#f92672">!</span> Storage.deleteBoQItem itemId
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Next, is the View part in the client. We are going to do following things:</p>
<ol>
<li>Let user edit column such as Description and UnitCost.</li>
<li>After user edit the column, we will call update Api on the server.</li>
<li>There will be delete button at the end of each row. Clicking that button will call delete Api on the server. The client then will load items from the server.</li>
</ol>
<p>Start off by let the user edit the Description column.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    ColumnDef.create<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        ColumnDef.headerName <span style="color:#e6db74">&#34;Description&#34;</span>
</span></span><span style="display:flex;"><span>        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Description<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ColumnDef.editable <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Then dispatch the UpdateBoQItem message after the updated Description has been set in the grid. Add following line before editable</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>        ColumnDef.valueSetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> newValue <span style="color:#f92672">_</span> row  <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> row <span style="color:#66d9ef">with</span> Description <span style="color:#f92672">=</span> newValue <span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> UpdateBoQItem <span style="color:#f92672">|&gt;</span> dispatch<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We don&rsquo;t have UpdateBoQItem yet. We will add this message and its response counterpart in the Msg type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdateBoQItem <span style="color:#66d9ef">of</span> BoQItemDto
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>and implement these 2 new cases in the update function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdateBoQItem <span style="color:#f92672">(</span>boqItem<span style="color:#f92672">:</span> BoQItemDto<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>updateBoQItem boqItem   UpdatedBoQItem
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#f92672">(</span>Ok updatedItem<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> updatedItems <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>BoQItems <span style="color:#f92672">|&gt;</span> List.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>Id <span style="color:#f92672">=</span> updatedItem<span style="color:#f92672">.</span>Id <span style="color:#66d9ef">then</span> updatedItem <span style="color:#66d9ef">else</span> x<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> updatedItems<span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> failwith msg
</span></span></code></pre></div><p>Just change all the ColumnDef to be editable and dispatch the Update msg in valueSetter function. If you change the value and tab out, you will see that row is changes. Refresh the browser will show the change value since the data is persist on the Server.</p>
<p>But if you enter blank value in the Description column, nothing will happen. Safe-stack usually will show the error in either in Terminal for Server code or Browser Console for Client Code. Checking the client code.</p>
<figure><img src="/posts/safe-stack/images/no-description-error.jpg"
    alt="No Description Error" width="600"><figcaption>
      <h4>No Description Error in Console</h4>
    </figcaption>
</figure>

<p>This occurs because we do use failWith when Error is captured in UpdatedBoQItem case. We are going to show this error to the user instead using Elmish.Toastr.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd src/Client
</span></span><span style="display:flex;"><span>femto install Elmish.Toastr
</span></span><span style="display:flex;"><span>cd ../..
</span></span><span style="display:flex;"><span>npm install jquery
</span></span></code></pre></div><p>Now create function showError and replace all failWith with the function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> showError model msg <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Error occurred : {msg}&#34;</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">,</span> Toastr.message msg <span style="color:#f92672">|&gt;</span> Toastr.error
</span></span></code></pre></div><p>In update function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> showError model msg
</span></span></code></pre></div><p>Now when we try to update blank Description, the error should shown in Toast like below:</p>
<figure><img src="/posts/safe-stack/images/no-description-error-toastr.jpg"
    alt="No Description Error Toastr" width="600"><figcaption>
      <h4>No Description Error with Toastr</h4>
    </figcaption>
</figure>

<p>Next, add delete button in Grid. Add new ColumnDef at the end:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    ColumnDef.create<span style="color:#f92672">&lt;</span>Guid<span style="color:#f92672">&gt;</span> <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        ColumnDef.valueGetter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Id<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        ColumnDef.cellRendererFramework <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> itemId <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            Html.button <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;&#34;</span>
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>onClick <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> dispatch <span style="color:#f92672">(</span>DeleteBoQItem itemId<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Add 2 more Msg for Delete and implement the case in update function as follow:</p>
<p>Msg type</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> DeleteBoQItem <span style="color:#66d9ef">of</span> itemId<span style="color:#f92672">:</span>Guid
</span></span></code></pre></div><p>update function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> DeleteBoQItem itemId <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>deleteBoQItem itemId <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> GetBoQItems<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span></code></pre></div><p>See that after finish delete, we will dispatch GetBoQItems to reload the items from Server.</p>
<p>Clicking on Delete button should delete and refresh the grid.</p>
<h2 id="calculate-all-cost">Calculate All Cost<a href="#calculate-all-cost" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>We would like to show user the latest cost of the Project. There are 3 cost that user are interested. They are DirectCost, FactorF, and EstimateCost. The calculation for this costs has already been implemented in the Domain. So all you have to do is just call the domain from the Api and return the result back to client.</p>
<p>Since we want the uesr to see the cost after each update. So we decide to return the AllCost to the user whenever there is changes for BoQItem.</p>
<p>Modify the Api in Shared module to return AllCost as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">AllCost</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        DirectCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>        FactorF <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>        EstimateCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ICoCoTenderApi</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    getBoQItems<span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto <span style="color:#66d9ef">list</span><span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>    addBoQItem<span style="color:#f92672">:</span> BoQItemDto <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>    updateBoQItem<span style="color:#f92672">:</span> BoQItemDto <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span>    deleteBoQItem<span style="color:#f92672">:</span> Guid <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unit</span><span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>    
</span></span></code></pre></div><p>Go to Server.fs. First, we will implement getAllCost function so that we can reuse in all Api functions. Put the function before definition of cocoTenderApi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> getAllCost () <span style="color:#f92672">=</span> result <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span><span style="color:#f92672">!</span> <span style="color:#f92672">(</span>DirectCost directCost<span style="color:#f92672">,</span> FactorF factorF<span style="color:#f92672">,</span> EstimateCost estimateCost<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        Project.tryGetAllCost Storage.loadFactorFTable <span style="color:#f92672">(</span>Storage.boqItems <span style="color:#f92672">|&gt;</span> List.ofSeq<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            DirectCost <span style="color:#f92672">=</span> directCost
</span></span><span style="display:flex;"><span>            FactorF <span style="color:#f92672">=</span> factorF
</span></span><span style="display:flex;"><span>            EstimateCost <span style="color:#f92672">=</span> estimateCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>We need to load factor f from the Storage. Implement following function in the Storage module.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> loadFactorFTable () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        FactorFTable <span style="color:#f92672">[(</span>10<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>1<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>100<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>5<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>1000<span style="color:#f92672">,</span> 1<span style="color:#f92672">.</span>9<span style="color:#f92672">)]</span>
</span></span></code></pre></div><p>Modify the Api to return allCost as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    getBoQItems <span style="color:#f92672">=</span> <span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> boqItems <span style="color:#f92672">=</span> Storage.boqItems <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let!</span> allCost <span style="color:#f92672">=</span> getAllCost()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>boqItems <span style="color:#f92672">|&gt;</span> List.map Dto.toBoQItemDto<span style="color:#f92672">),</span> allCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    addBoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fun</span> boqItemDto <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItemDto <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDomain
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> Storage.addBoQItem boqItem
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> boqItemDto<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> boqItem <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDto
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let!</span> allCost <span style="color:#f92672">=</span> getAllCost()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> boqItemDto&#39;<span style="color:#f92672">,</span> allCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    updateBoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fun</span> boqItemDto <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItemDto <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDomain
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let!</span> boqItem <span style="color:#f92672">=</span>  boqItem <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdate
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> Storage.updateBoQItem boqItem
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> boqItemDto<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> boqItem <span style="color:#f92672">|&gt;</span> Dto.toBoQItemDto
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let!</span> allCost <span style="color:#f92672">=</span> getAllCost()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> boqItemDto&#39;<span style="color:#f92672">,</span> allCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Go back to Client.fs. We need to maintain AllCost received from the server. So we need to modify the Model as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Model</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        BoQItems<span style="color:#f92672">:</span> BoQItemDto <span style="color:#66d9ef">list</span>
</span></span><span style="display:flex;"><span>        AllCost<span style="color:#f92672">:</span> AllCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Change the init to initialize AllCost</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> model <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            BoQItems <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            AllCost <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>DirectCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> EstimateCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Change the Msg to accept AllCost from response from the Server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotBoQItems <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto <span style="color:#66d9ef">list</span><span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddedBoQItem <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>BoQItemDto<span style="color:#f92672">*</span>AllCost<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>Modify the response cases in update as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotBoQItems <span style="color:#f92672">(</span>Ok <span style="color:#f92672">(</span>items<span style="color:#f92672">,</span>allCost<span style="color:#f92672">))</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> items<span style="color:#f92672">;</span> AllCost <span style="color:#f92672">=</span> allCost <span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> AddedBoQItem <span style="color:#f92672">(</span>Ok <span style="color:#f92672">(</span>boqItem<span style="color:#f92672">,</span> allCost<span style="color:#f92672">))</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>BoQItems <span style="color:#f92672">@</span> <span style="color:#f92672">[</span> boqItem <span style="color:#f92672">];</span> AllCost <span style="color:#f92672">=</span> allCost <span style="color:#f92672">},</span> Cmd.none        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatedBoQItem <span style="color:#f92672">(</span>Ok <span style="color:#f92672">(</span>updatedItem<span style="color:#f92672">,</span>allCost<span style="color:#f92672">))</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> updatedItems <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>BoQItems <span style="color:#f92672">|&gt;</span> List.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">if</span> x<span style="color:#f92672">.</span>Id <span style="color:#f92672">=</span> updatedItem<span style="color:#f92672">.</span>Id <span style="color:#66d9ef">then</span> updatedItem <span style="color:#66d9ef">else</span> x<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> BoQItems <span style="color:#f92672">=</span> updatedItems<span style="color:#f92672">;</span> AllCost <span style="color:#f92672">=</span> allCost <span style="color:#f92672">},</span> Cmd.none
</span></span></code></pre></div><p>We will show code below the Grid. At following Bulma Level under grid inside containerBox function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>            Bulma.level <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>style <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    style<span style="color:#f92672">.</span>paddingRight 300
</span></span><span style="display:flex;"><span>                    style<span style="color:#f92672">.</span>fontSize 14
</span></span><span style="display:flex;"><span>                    style<span style="color:#f92672">.</span>fontWeight<span style="color:#f92672">.</span>bold
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                color<span style="color:#f92672">.</span>hasBackgroundLight
</span></span><span style="display:flex;"><span>                prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    Bulma.levelLeft []
</span></span><span style="display:flex;"><span>                    Bulma.levelRight <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        Bulma.levelItem <span style="color:#f92672">(</span>Bulma.label <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Direct Cost&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        Bulma.levelItem <span style="color:#f92672">(</span>Bulma.label <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;{model.AllCost.DirectCost}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        Bulma.levelItem <span style="color:#f92672">(</span>Bulma.label <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                        Bulma.levelItem <span style="color:#f92672">(</span>Bulma.label <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;{model.AllCost.EstimateCost}&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>The all cost should be shown as follow:</p>
<figure><img src="/posts/safe-stack/images/show-all-cost.jpg"
    alt="Show All Cost" width="600"><figcaption>
      <h4>Show All Cost</h4>
    </figcaption>
</figure>

<h2 id="show-factorf-table">Show FactorF Table<a href="#show-factorf-table" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Finally, we are at the last use case for this post. The user should be able to see FactorF table used for the calculation. We have factor f returned from the Server but we need to somehow show the table and highlight which factor f range we are using.</p>
<p>First, add new function in Api shared module to get FactorFInfo</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FactorFInfo</span> <span style="color:#f92672">=</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">string</span><span style="color:#f92672">*</span><span style="color:#66d9ef">float</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">list</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ICoCoTenderApi</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    getFactorFInfo<span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span><span style="color:#f92672">-&gt;</span>Async<span style="color:#f92672">&lt;</span>Result<span style="color:#f92672">&lt;</span>FactorFInfo<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Next implement it in the Server.fs.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    getFactorFInfo <span style="color:#f92672">=</span> <span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span> asyncResult <span style="color:#f92672">{</span> <span style="color:#66d9ef">return</span> Project.getFactorFInfo Storage.loadFactorFTable <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>For the user interface, we will use Bulma.QuickView.
We need to install it first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>femto install Feliz.Bulma.QuickView
</span></span></code></pre></div><p>The QuickView requires custom css style. We need to import that when we bundle client-side fsharp to js file. The client pipeline is done through webpack.</p>
<p>Go to webpack.config.js and add cssEntry in CONFIG object after fsharpEntry.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#a6e22e">cssEntry</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;./src/Client/style.scss&#39;</span>,
</span></span></code></pre></div><p>Next go to entry property in Module.export. We need to bundle css entry when we build the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>        <span style="color:#a6e22e">entry</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">isProduction</span> <span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">app</span><span style="color:#f92672">:</span> [<span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">CONFIG</span>.<span style="color:#a6e22e">fsharpEntry</span>), <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">CONFIG</span>.<span style="color:#a6e22e">cssEntry</span>)]
</span></span><span style="display:flex;"><span>        } <span style="color:#f92672">:</span> <span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">test</span> <span style="color:#f92672">?</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">app</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">config</span>.<span style="color:#a6e22e">fsharpEntry</span>)
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">:</span>   {
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">app</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">CONFIG</span>.<span style="color:#a6e22e">fsharpEntry</span>),
</span></span><span style="display:flex;"><span>                    <span style="color:#a6e22e">style</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">resolve</span>(<span style="color:#a6e22e">CONFIG</span>.<span style="color:#a6e22e">cssEntry</span>)
</span></span><span style="display:flex;"><span>                },
</span></span></code></pre></div><p>Next create the file style.scss inside src/Client folder and put below code to import quickview css</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-scss" data-lang="scss"><span style="display:flex;"><span><span style="color:#66d9ef">@import</span> <span style="color:#e6db74">&#39;~bulma-quickview/dist/css/bulma-quickview.min.css&#39;</span>;
</span></span></code></pre></div><p>Go to Index.fs and add 2 more item in the Model type</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Model</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>        ShowFactorFView<span style="color:#f92672">:</span> <span style="color:#66d9ef">bool</span>
</span></span><span style="display:flex;"><span>        FactorFInfo<span style="color:#f92672">:</span> FactorFInfo
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>The first one is the flag indicating that the FactorF quickview should be shown or not. The second one is just the factor f table we got from the Server.</p>
<p>Two more Msgs are added:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> ToggleFactorFView
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotFactorFInfo <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>FactorFInfo<span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>The first message will be used when we toggle the factorf view to open or close. The second one will be when we receive the table.</p>
<p>Change the init function so that we will send 2 request in the beginning. First request will load the boq items, The second one will load factor f table.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> init () <span style="color:#f92672">:</span> Model <span style="color:#f92672">*</span> Cmd<span style="color:#f92672">&lt;</span>Msg<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> model <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            BoQItems <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>            AllCost <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>DirectCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> EstimateCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0<span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            ShowFactorFView <span style="color:#f92672">=</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>            FactorFInfo <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> cmdGetBoQItems <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>getBoQItems () GotBoQItems
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> cmdGetFactorFInfo <span style="color:#f92672">=</span> Cmd.OfAsync.perform cocoTenderApi<span style="color:#f92672">.</span>getFactorFInfo () GotFactorFInfo
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">,</span> Cmd.batch <span style="color:#f92672">[</span> cmdGetBoQItems<span style="color:#f92672">;</span> cmdGetFactorFInfo <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Add 2 more cases in the update function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotFactorFInfo <span style="color:#f92672">(</span>Ok info<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> FactorFInfo <span style="color:#f92672">=</span> info <span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotFactorFInfo <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> showError&#39; msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> ToggleFactorFView <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> ShowFactorFView <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>ShowFactorFView <span style="color:#f92672">|&gt;</span> <span style="color:#f92672">not</span> <span style="color:#f92672">},</span> Cmd.none
</span></span></code></pre></div><p>In the view, we will toggle the view through button. Add new level item next to EstimateCost.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    Bulma.levelItem <span style="color:#f92672">(</span>
</span></span><span style="display:flex;"><span>        Bulma.button<span style="color:#f92672">.</span>button <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;Show Factor F&#34;</span>
</span></span><span style="display:flex;"><span>            prop<span style="color:#f92672">.</span>onClick <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> ToggleFactorFView <span style="color:#f92672">|&gt;</span> dispatch<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Last but not least, create the factorFView function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> factorFView <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">)</span> dispatch <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    printfn <span style="color:#e6db74">&#34;Info %A Factor F %A&#34;</span> model<span style="color:#f92672">.</span>FactorFInfo model<span style="color:#f92672">.</span>AllCost<span style="color:#f92672">.</span>FactorF
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> lowerBoundIndex <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>FactorFInfo <span style="color:#f92672">|&gt;</span> List.tryFindIndexBack <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#f92672">|&gt;</span> snd <span style="color:#f92672">|&gt;</span> <span style="color:#f92672">(&gt;=)</span> model<span style="color:#f92672">.</span>AllCost<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    printfn <span style="color:#e6db74">&#34;LowerBoundIndex %A&#34;</span> lowerBoundIndex
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> factorFTr i <span style="color:#f92672">(</span>condition<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">,</span>factorF<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> isSelected <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> lowerBoundIndex <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Some index <span style="color:#f92672">-&gt;</span> i <span style="color:#f92672">=</span> index <span style="color:#f92672">||</span> i <span style="color:#f92672">=</span> <span style="color:#f92672">(</span>index <span style="color:#f92672">+</span> 1<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">false</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Html.tr <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> isSelected <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">yield</span> prop<span style="color:#f92672">.</span>className <span style="color:#e6db74">&#34;is-selected&#34;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">yield</span> prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>Html.td condition<span style="color:#f92672">;</span> Html.td <span style="color:#f92672">(</span>factorF <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    QuickView.quickview <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> model<span style="color:#f92672">.</span>ShowFactorFView <span style="color:#66d9ef">then</span> <span style="color:#66d9ef">yield</span> quickview<span style="color:#f92672">.</span>isActive
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">yield</span> prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            QuickView.header <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                Html.div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    prop<span style="color:#f92672">.</span>style <span style="color:#f92672">[</span> style<span style="color:#f92672">.</span>color<span style="color:#f92672">.</span>black <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;Factor F&#34;</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                Bulma.delete <span style="color:#f92672">[</span> prop<span style="color:#f92672">.</span>onClick <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> ToggleFactorFView <span style="color:#f92672">|&gt;</span> dispatch<span style="color:#f92672">)</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            QuickView.body <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                QuickView.block <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    Bulma.table <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        Html.thead <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                            Html.tr <span style="color:#f92672">[</span> Html.th <span style="color:#e6db74">&#34;Direct Cost Condition&#34;</span><span style="color:#f92672">;</span> Html.th <span style="color:#e6db74">&#34;Factor F&#34;</span> <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                        Html.tbody <span style="color:#f92672">(</span>model<span style="color:#f92672">.</span>FactorFInfo <span style="color:#f92672">|&gt;</span> List.mapi factorFTr<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>And place the function below the containerBox in main view function</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>            Bulma.heroBody <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                Bulma.container <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    Bulma.title <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        text<span style="color:#f92672">.</span>hasTextCentered
</span></span><span style="display:flex;"><span>                        prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;CoCoTender&#34;</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    containerBox model dispatch
</span></span><span style="display:flex;"><span>                    factorFView model dispatch
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>The result should be as follow:</p>
<figure><img src="/posts/safe-stack/images/show-factor-f.jpg"
    alt="Show Factor F" width="600"><figcaption>
      <h4>Show Factor F</h4>
    </figcaption>
</figure>

<p>The final code could be clone from tag 0.3.0</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>git clone -b v0.3.0 https://github.com/twuttiwat/CoCoTender 
</span></span></code></pre></div><p>If you come this far, thank you so much for reading this lenghtly post with a lot of code. I am still not good at F# yet but I am still enjoy writing in the language everyday. I would like to thank Compositional-It who develop this Safe-stack framework. I really like it.
Also I have a lot of questions in F# in the beginning. People in the F# community (slack) is very helpful. I would like to thank Zaid Ajai,Shmew, and AngelMunoz who answer my question relentlessly.</p>
<p>Last but not least, thanks Sergey Tihon to let me participate in F# Advent of Code this year.</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span> 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
