<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Authentication With Json Web Token :: TW Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Happy New Year 2023! I finally have time to write this post. And it&rsquo;s the post, I am eager to write the most. Of all the resource in Safe stack, I found that authentication and authorization is the less well-known one.
Be it no more. In this post, I will show step by step how I create authentication with Jason Web Token (JWT) in Safe stack. The next post will be authorization.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/auth-with-jwt/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Authentication With Json Web Token">
<meta property="og:description" content="Happy New Year 2023! I finally have time to write this post. And it&rsquo;s the post, I am eager to write the most. Of all the resource in Safe stack, I found that authentication and authorization is the less well-known one.
Be it no more. In this post, I will show step by step how I create authentication with Jason Web Token (JWT) in Safe stack. The next post will be authorization.
" />
<meta property="og:url" content="http://localhost:1313/posts/auth-with-jwt/" />
<meta property="og:site_name" content="TW Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-01-12 21:02:25 &#43;0700 &#43;07" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/auth-with-jwt/">Authentication With Json Web Token</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-01-12</time><span class="post-author">Teerawat Wuttiwat</span></div>

  
  


  

  <div class="post-content"><div>
        <p>Happy New Year 2023!
I finally have time to write this post. And it&rsquo;s the post, I am eager to write the most. Of all the resource in Safe stack, I found that authentication and authorization is the less well-known one.</p>
<p>Be it no more. In this post, I will show step by step how I create authentication with Jason Web Token (JWT) in Safe stack. The next post will be authorization.</p>
<h1 id="background">Background<a href="#background" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>To understand authentication, one needs to understand how all Component in Safe stack comes together.
Safe stack consists of</p>
<ol>
<li>Saturn</li>
<li>Azure</li>
<li>Fable</li>
<li>Elmish</li>
</ol>
<p>Saturn is MVC web framework running on Giraffe and Kestrel (Asp.net Core).
So it makes sense to use all functionality provided by the framework since we have 3 of them here.
I found one very simple JWT sample code in Saturn source code (GitHub).
Initially, we will follow this code in our CoCoTender work</p>
<p>Since I plan to show how authorization works in step-by-step fashion, it&rsquo;s best to try in small step since it&rsquo;s not easy (at least for me)</p>
<h2 id="our-steps">Our Steps<a href="#our-steps" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<ol start="0">
<li>Learn how Safe Stack specifically Saturn works.</li>
<li>Prevent all access to Saturn</li>
<li>Create Login page and allow anyone to access it</li>
<li>Create Authentication Api which anyone can access</li>
<li>Allow access to other pages after user is authenticated</li>
<li>Allow access to other Apis after user is authenticated</li>
</ol>
<p>There a lot of steps to be done. So let&rsquo;s start now.</p>
<h2 id="learn-how-it-works">Learn how it works<a href="#learn-how-it-works" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>There are 2 environment in Safe stack.</p>
<ol>
<li>Development</li>
<li>Production</li>
</ol>
<p>For production, all the request will be handled by the Web server (Saturn).
But in development, things are different. Safe stack use webpack devserver as a proxy Web server.
All the incoming traffic will go through the devserver before being forwarded to our Saturn code in Server.fs.</p>
<p>We can proove that by checking the Network Request in Chrome. Here is the one from our current implementation.</p>
<figure><img src="/posts/auth-with-jwt/images/initial-chrome-network-request.png"
    alt="Initial Chrome Network Request" width="600"><figcaption>
      <h4>Chrome Network Request in the Beginning</h4>
    </figcaption>
</figure>

<p>It may not be obvious. But the network tab shows us that there is no Http request to get our index.html file from Saturn. This happens because webpack devserver does that for us.</p>
<p>But&hellip;, we want to control all the request through Saturn. The first step is to force the request to go through the webpack devserver and reach the Saturn.</p>
<p>Sound likes some kind of space journey ðŸš€ to me. :)</p>
<p>To change this webpack configuration, you need to change the webpack.config.js file. You will see this line:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#a6e22e">devServerProxy</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// redirect requests that start with /api/ to the server on port 5000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#39;/api/**&#39;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://localhost:&#39;</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">SERVER_PROXY_PORT</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;5000&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">changeOrigin</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        },
</span></span></code></pre></div><p>The aboved snippet tells us that only the request matching &lsquo;/api/**&rsquo; will be forwarded to Saturn.
We need to forward everything instead.
Here is the change</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#a6e22e">devServerProxy</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// redirect requests that start with /api/ to the server on port 5000
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#e6db74">&#39;**&#39;</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">target</span><span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;http://localhost:&#39;</span> <span style="color:#f92672">+</span> (<span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">env</span>.<span style="color:#a6e22e">SERVER_PROXY_PORT</span> <span style="color:#f92672">||</span> <span style="color:#e6db74">&#39;5000&#39;</span>),
</span></span><span style="display:flex;"><span>            <span style="color:#a6e22e">changeOrigin</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>
</span></span><span style="display:flex;"><span>        },
</span></span></code></pre></div><p>If you look at the Network tab in Chrome again, you will see no change. So.. changing the devserver proxy is not enough. But wait, there seems to be some changes in the network request, if you scrolldown a bit, you will see there are <em>404</em> error when requesting favicon.png.
So our change is working for favicon file but not the index html file.</p>
<figure><img src="/posts/auth-with-jwt/images/chrome-network-request-forward-all-requests.png"
    alt="Forward All Requests Chrome Network Request" width="600"><figcaption>
      <h4>Chrome Network Request after Changing webserver proxy</h4>
    </figcaption>
</figure>

<p>The problem comes from the assumption of webpack devserver. It assumes that it should always serves the file with name (you guessed it) <strong>index.html</strong>. All we needs to do is rename the file to app.html and change all reference to that file.</p>
<ol>
<li>Rename from index.html to app.html</li>
<li>Change all reference of index.html in webpack.config.js to app.html</li>
</ol>
<p>Here is the result from console output:</p>
<figure><img src="/posts/auth-with-jwt/images/change-index-html-to-app-html.png"
    alt="Change Index Html to App Html" width="600"><figcaption>
      <h4>Console output after renaming index.html</h4>
    </figcaption>
</figure>

<p>It&rsquo;s a bit better. You can see that all traffic has been forwarded to port 5000 which is the port for Saturn.
But it does not return our app.html file because the Saturn does not knows about this. It&rsquo;s time for us to do a bit of coding now.</p>
<p>Go to the bottom of Server.fs file. Here is the current application computation expression for our Server code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> app <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    application <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        use_router webApp
</span></span><span style="display:flex;"><span>        memory_cache
</span></span><span style="display:flex;"><span>        use_static <span style="color:#e6db74">&#34;public&#34;</span>
</span></span><span style="display:flex;"><span>        use_gzip
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>We will focus on what matters here first. The use_router is what we want to change because the router is used as a way to routing http request in Saturn app. Currently, it points to webApp which is a HttpHandle for our Api. (HttpHandle likes it name just the object that will serve the http request)
We will change the router to explicitly serve our app.html file instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>        use_router <span style="color:#f92672">(</span>htmlFile <span style="color:#e6db74">&#34;public/app.html&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Below log from console tells us that Saturn are trying to serve <strong>app.html</strong> file from our public directory. Since we do not provide that yet, the log will show file not found error.</p>
<figure><img src="/posts/auth-with-jwt/images/not-found-app-html.png"
    alt="Not Found App Html" width="600"><figcaption>
      <h4>Console showing App.html file is not found</h4>
    </figcaption>
</figure>

<p>We can simply copy app.html file from Client to Server public folder. Unfortunately, that&rsquo;s not enough. Webpack will transplie all F# client-side file to JS and emit to Client output folder specified in webpack.config.js (outputDir). The webpack then will serve all application client-side file (html, js and css) from this output folder.</p>
<p>Since, we are going to serve everything from Server-side. We then need to change outputDir from ./src/Client/output to ./src/Server/public since we serves our new app.html from Server/public folder. This changes need to be done only in Development mode since it&rsquo;s the only mode that running through webpack devserver. Setting this outputDir is not enough, we need to tell webpack that we want to write the output file to disk.</p>
<p>Here are all steps needs to be done:</p>
<ol>
<li>Change outputDir in Development mode.
First, go to webpack.config.js and add following line at the top.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#66d9ef">var</span> <span style="color:#a6e22e">isProduction</span> <span style="color:#f92672">=</span> <span style="color:#f92672">!</span><span style="color:#a6e22e">process</span>.<span style="color:#a6e22e">argv</span>.<span style="color:#a6e22e">find</span>(<span style="color:#a6e22e">v</span> =&gt; <span style="color:#a6e22e">v</span>.<span style="color:#a6e22e">indexOf</span>(<span style="color:#e6db74">&#39;webpack-dev-server&#39;</span>) <span style="color:#f92672">!==</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>);
</span></span></code></pre></div><ol start="2">
<li>Change outputDir to new Server/public when in Development mode.</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>    <span style="color:#a6e22e">outputDir</span><span style="color:#f92672">:</span> <span style="color:#a6e22e">isProduction</span> <span style="color:#f92672">?</span> <span style="color:#e6db74">&#39;./deploy/public&#39;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74">&#39;./src/Server/public&#39;</span>,   
</span></span></code></pre></div><ol start="3">
<li>Enable writeToDisk in devServer</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span>            <span style="color:#a6e22e">devMiddleware</span><span style="color:#f92672">:</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#a6e22e">writeToDisk</span><span style="color:#f92672">:</span> <span style="color:#66d9ef">true</span>,
</span></span><span style="display:flex;"><span>            },
</span></span></code></pre></div><p>Finally, we could bring back the index page (now app.html) now. But if you look at the log, when go to BoQ page (http://localhost:8080/#/boq), you will see 404 error code when calling getBoQItems and getFactorInfo.</p>
<figure><img src="/posts/auth-with-jwt/images/api-404.png"
    alt="Api 404" width="600"><figcaption>
      <h4>Could not call Api</h4>
    </figcaption>
</figure>

<p>A little bit more, we can then bring back our app to the working state. What we have done so far is to Get &ldquo;/&rdquo; request to <strong>app.html</strong> first. But we haven&rsquo;t do anything for our api request. All api request will be in the form of /api/<em>TypeName</em>/<em>MethodName</em>. So all we have to do is forward all request having <strong>api</strong> prefix to our webApp HttpHandler.</p>
<p>Here is the change in Server.fs topRouter function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> topRouter <span style="color:#f92672">=</span> router <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    get <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">(</span>htmlFile <span style="color:#e6db74">&#34;public/app.html&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    forward <span style="color:#e6db74">&#34;/api&#34;</span> webApp
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Then you will see that the api return data correctly this time. Next step is to prevent that.</p>
<h2 id="prevent-all-access-to-saturn">Prevent all access to Saturn<a href="#prevent-all-access-to-saturn" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>We will prevent all access to our Saturn web server by forcing all request to to through JWT authentication pipeline in our <strong>topRouter</strong>.</p>
<p>But before we can use use JWT authentication, we need to config it in our application first.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> secret <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;Your Secret&gt;&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> issuer <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&lt;Your Issuer url i.e. your.domain.com&gt;&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> app <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    application <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        use_jwt_authentication secret issuer
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Then we will add our require authentication pipeline before all request in the router.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> topRouter <span style="color:#f92672">=</span> router <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    pipe_through <span style="color:#f92672">(</span>Auth.requireAuthentication JWT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>When we see the result in Chrome network tab, you will see that it return <strong>401</strong> code which means <strong>UnAuthorized</strong> error. This means that our Saturn knows that this request is not authenticated and return such error.</p>
<figure><img src="/posts/auth-with-jwt/images/prevent-all-access-saturn.png"
    alt="Prevent All Access Saturn" width="600"><figcaption>
      <h4>Unauthorized Access for All Web Requests</h4>
    </figcaption>
</figure>

<p>We could prevent all our application now. Next step is to allow only authenticated request.</p>
<h2 id="make-authenticated-request">Make Authenticated Request<a href="#make-authenticated-request" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>We can get authenticated request by supplying all our http request with JWT (Jason Web Token). The token can be request from the server. Usually the step will be done like this:</p>
<ol>
<li>User get token by supplying username and password.</li>
<li>The server will verify that user and password is correct and send back the Token to client.</li>
<li>From now on, the client will use the token in all Http request header. We will call this authenticated request.</li>
<li>When the server receive the authenticated request, it will let the request pass through the pipeline.</li>
</ol>
<p>Let&rsquo;s start by create function to generate token below in file Server.fs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> generateToken email <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> claims <span style="color:#f92672">=</span> <span style="color:#f92672">[|</span>
</span></span><span style="display:flex;"><span>        Claim<span style="color:#f92672">(</span>JwtRegisteredClaimNames.Sub<span style="color:#f92672">,</span> email<span style="color:#f92672">);</span>
</span></span><span style="display:flex;"><span>        Claim<span style="color:#f92672">(</span>JwtRegisteredClaimNames.Jti<span style="color:#f92672">,</span> Guid.NewGuid()<span style="color:#f92672">.</span>ToString()<span style="color:#f92672">)</span> <span style="color:#f92672">|]</span>
</span></span><span style="display:flex;"><span>    claims
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Auth.generateJWT <span style="color:#f92672">(</span>secret<span style="color:#f92672">,</span> SecurityAlgorithms.HmacSha256<span style="color:#f92672">)</span> issuer <span style="color:#f92672">(</span>DateTime.UtcNow.AddHours<span style="color:#f92672">(</span>1<span style="color:#f92672">.</span>0<span style="color:#f92672">))</span>
</span></span></code></pre></div><p>All of this required Identity package which can be installed in Paket as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet paket add System.IdentityModel.Tokens.Jwt  --version 6.25.1 -p Server
</span></span></code></pre></div><p>The function will create <strong>Claim</strong> using supplied email. Claim is like identity for user of the token. From now on, when request comes with token, the Api can get the identity (email) from the token.</p>
<p>The function aboved create JWT token with valid time of 1 hour. After one hour passed, the token will be expired. The client need to refresh the token to extend the session period.
I did try that in our scratch.fsx files and it is working fine.</p>
<p>Next, we need to let the client use this generate token function. Let&rsquo;s create new Api for this authentication purpose</p>
<p>Go to shared.fs and add new Api interface as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Token</span> <span style="color:#f92672">=</span> Token <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IAuthApi</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span> login<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">*</span><span style="color:#66d9ef">string</span> <span style="color:#f92672">-&gt;</span> Async<span style="color:#f92672">&lt;</span>Token<span style="color:#f92672">&gt;</span> <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Then implement the login function in Server.fs:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> authApi <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    login <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>email<span style="color:#f92672">,</span> password<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            async <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ok&#34;</span><span style="color:#f92672">)</span> <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>generateToken email<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">else</span> 
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">return</span> <span style="color:#f92672">(</span>failwith <span style="color:#e6db74">&#34;Login Failed&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>We just check if the password is <em>ok</em> before return new token. Otherwise, we just raise the error.</p>
<p>Next, we just need to allow any users to use this api. Let&rsquo;s call this anonymousApi.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> anonymousApi <span style="color:#f92672">:</span> HttpHandler <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.fromValue authApi
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildHttpHandler
</span></span></code></pre></div><p>Then, create securedApi that will simply call our business logic Api:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> securedApi  <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.fromValue <span style="color:#f92672">(</span>cocoTenderApi <span style="color:#f92672">(</span>LiteDBStorage()<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildHttpHandler
</span></span></code></pre></div><p>Now, merge both Api into complete Api:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> completeApi <span style="color:#f92672">:</span> HttpHandler <span style="color:#f92672">=</span> choose <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>    anonymousApi
</span></span><span style="display:flex;"><span>    pipeline <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        requires_authentication <span style="color:#f92672">(</span>Giraffe.Auth.challenge <span style="color:#e6db74">&#34;JWT&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        plug securedApi
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>As you can see, anyone can access anonymouse Api but only authenticated request can call secured api.</p>
<p>Finally, just plug the completeApi to the Router:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> topRoute <span style="color:#f92672">=</span> router <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    get <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">(</span>htmlFile <span style="color:#e6db74">&#34;public/app.html&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    forward <span style="color:#e6db74">&#34;/api&#34;</span> completeApi
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>We remove the line <strong>pipe_through (Auth.requireAuthentication JWT)</strong> because it has moved to the completeApi now.</p>
<p>Let&rsquo;s create our Login page so that user can perform login to the UI.</p>
<p>Go to Pages folder in Client project and create Login.fs file.</p>
<p>Start by creating Model for our Login page:
We will store Email and Password in our Model before submitting to our Authentication api.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Model</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span> 
</span></span><span style="display:flex;"><span>        Email <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>        Password <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>Our Msg will be just for Login purpose. We will have actual Login Msgs and Msgs related to updating login parameter as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Msg</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdateEmail <span style="color:#66d9ef">of</span> email<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatePassword <span style="color:#66d9ef">of</span> password<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Login
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> LoggedIn <span style="color:#66d9ef">of</span> Result<span style="color:#f92672">&lt;</span>Token<span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotError <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">exn</span>
</span></span></code></pre></div><p>We will call our authentication Api here. So we need to create api proxy on the client-side like what we did with CoCoTenderApi one.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> authApi <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.withRouteBuilder Route.builder
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildProxy<span style="color:#f92672">&lt;</span>IAuthApi<span style="color:#f92672">&gt;</span>
</span></span></code></pre></div><p>Start with init function. We will make the Email and Password blank in the beginning.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> init () <span style="color:#f92672">:</span> Model <span style="color:#f92672">*</span> Cmd<span style="color:#f92672">&lt;</span>Msg<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> model <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> Email <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span> Password <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    model<span style="color:#f92672">,</span> Cmd.none
</span></span></code></pre></div><p>Then, the update function we will handle the Msg as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> update <span style="color:#f92672">(</span>msg<span style="color:#f92672">:</span> Msg<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">)</span> <span style="color:#f92672">:</span> Model <span style="color:#f92672">*</span> Cmd<span style="color:#f92672">&lt;</span>Msg<span style="color:#f92672">&gt;</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> showError<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> showError model
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> msg <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdateEmail email <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> Email <span style="color:#f92672">=</span> email <span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> UpdatePassword pwd <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">{</span> model <span style="color:#66d9ef">with</span> Password <span style="color:#f92672">=</span> pwd <span style="color:#f92672">},</span> Cmd.none
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Login <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        printf <span style="color:#e6db74">&#34;Loggin In&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.OfAsync.either authApi<span style="color:#f92672">.</span>login <span style="color:#f92672">(</span>model<span style="color:#f92672">.</span>Email<span style="color:#f92672">,</span> model<span style="color:#f92672">.</span>Password<span style="color:#f92672">)</span> LoggedIn GotError
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> LoggedIn <span style="color:#f92672">(</span>Ok <span style="color:#f92672">(</span>Token token<span style="color:#f92672">))</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        printf <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Token {token}&#34;</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> LoggedIn <span style="color:#f92672">(</span>Error msg<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        showError&#39; msg
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> GotError ex <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        printf <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;LoggedIn Error {ex.Message}&#34;</span>
</span></span><span style="display:flex;"><span>        showError&#39; msg
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> Cmd.none
</span></span></code></pre></div><p>The aboved code will return token when the login is success.
Next is to show UI for our Login page.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> view<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>dispatch<span style="color:#f92672">:</span> Msg <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">unit</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Bulma.hero <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        hero<span style="color:#f92672">.</span>isFullHeight
</span></span><span style="display:flex;"><span>        color<span style="color:#f92672">.</span>isPrimary
</span></span><span style="display:flex;"><span>        prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            Bulma.heroBody <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                Bulma.container <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                    Bulma.column <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                        column<span style="color:#f92672">.</span>is6
</span></span><span style="display:flex;"><span>                        column<span style="color:#f92672">.</span>isOffset3
</span></span><span style="display:flex;"><span>                        prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                            Bulma.field<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                Bulma.label <span style="color:#e6db74">&#34;Email&#34;</span>
</span></span><span style="display:flex;"><span>                                Bulma.control<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                    Bulma.input<span style="color:#f92672">.</span>text <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>value model<span style="color:#f92672">.</span>Email
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>placeholder <span style="color:#e6db74">&#34;a@b.com&#34;</span>
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>onChange <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>email<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>  email <span style="color:#f92672">|&gt;</span> UpdateEmail <span style="color:#f92672">|&gt;</span> dispatch<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                            Bulma.field<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                Bulma.label <span style="color:#e6db74">&#34;Password&#34;</span>
</span></span><span style="display:flex;"><span>                                Bulma.control<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                    Bulma.input<span style="color:#f92672">.</span>password <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>value model<span style="color:#f92672">.</span>Password
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>placeholder <span style="color:#e6db74">&#34;*****&#34;</span>
</span></span><span style="display:flex;"><span>                                        prop<span style="color:#f92672">.</span>onChange <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>pwd<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span>  pwd <span style="color:#f92672">|&gt;</span> UpdatePassword <span style="color:#f92672">|&gt;</span> dispatch<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                            Bulma.field<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                Bulma.field<span style="color:#f92672">.</span>isGrouped
</span></span><span style="display:flex;"><span>                                Bulma.field<span style="color:#f92672">.</span>isGroupedCentered
</span></span><span style="display:flex;"><span>                                prop<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                    Bulma.control<span style="color:#f92672">.</span>div <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                        Bulma.button<span style="color:#f92672">.</span>button <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>                                            Bulma.color<span style="color:#f92672">.</span>isLink
</span></span><span style="display:flex;"><span>                                            prop<span style="color:#f92672">.</span>text <span style="color:#e6db74">&#34;Login&#34;</span>
</span></span><span style="display:flex;"><span>                                            prop<span style="color:#f92672">.</span>onClick <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> dispatch Login<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>                                        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>                        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>                <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Feliz.UseElmish
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> view <span style="color:#f92672">=</span> React.functionComponent<span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> () <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> <span style="color:#f92672">(</span>model<span style="color:#f92672">:</span> Model<span style="color:#f92672">),</span> dispatch <span style="color:#f92672">=</span> React.useElmish<span style="color:#f92672">(</span>init<span style="color:#f92672">,</span> update<span style="color:#f92672">,</span> <span style="color:#f92672">[|</span> <span style="color:#f92672">|])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    view&#39; model dispatch
</span></span><span style="display:flex;"><span><span style="color:#f92672">)</span>
</span></span></code></pre></div><p>We have the code for login page in place, we need to render the page in Index.fs. First, go to Router.fs to create Login page type.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Page</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Login
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Home
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> BoQ
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> parseUrl <span style="color:#f92672">=</span> <span style="color:#66d9ef">function</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">[</span> <span style="color:#f92672">]</span> <span style="color:#f92672">-&gt;</span> Login
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;boq&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">-&gt;</span> BoQ
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;login&#34;</span> <span style="color:#f92672">]</span> <span style="color:#f92672">-&gt;</span> Login
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> Login
</span></span></code></pre></div><p>As you can see, be default we will map path to  Login page where there is no custom Url path specified.</p>
<p>Now go to Index.fs to do actual rendering in view function:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> activePage <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> model<span style="color:#f92672">.</span>CurrentPage <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Login <span style="color:#f92672">-&gt;</span> Pages.Login.view()
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Home <span style="color:#f92672">-&gt;</span> Pages.Home.view()
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> BoQ <span style="color:#f92672">-&gt;</span> Pages.BoQ.view()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> viewPage model dispatch
</span></span></code></pre></div><p>Now, if you run the project and it will show the Login page. Entering user with some test email with password being &lsquo;ok&rsquo;, You will get following result:</p>
<figure><img src="/posts/auth-with-jwt/images/return-token-after-logged-in.png"
    alt="Return Token after Logged In" width="600"><figcaption>
      <h4>Show returning token in Console after successful logged in</h4>
    </figcaption>
</figure>

<p>Now, it is a good time to define how to prevent client to browse to any pages. After looking at sample in Saturn repository, I decide to go with securing the route. Basically, we will create route <code>secured</code> which we allow only authenticate request. You just need to add 2 more blocks in the <code>Server.fs</code> file</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#75715e">// ... After authApi definition
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> securedRouter <span style="color:#f92672">=</span> router <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    pipe_through <span style="color:#f92672">(</span>Auth.requireAuthentication JWT<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// ... Replace topRouter
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> topRouter <span style="color:#f92672">=</span> router <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    get <span style="color:#e6db74">&#34;/&#34;</span> <span style="color:#f92672">(</span>htmlFile <span style="color:#e6db74">&#34;public/app.html&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    forward <span style="color:#e6db74">&#34;/secured&#34;</span> securedRouter
</span></span><span style="display:flex;"><span>    forward <span style="color:#e6db74">&#34;/api&#34;</span> completeApi
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>After finish login, the client need to redirect to secured page with returning JWT token.
There are quite a few steps involved. I will list all of them here. And show the code one by one..</p>
<ol>
<li>After successfully login, keep the JWT token in local storage.</li>
<li>Navigate to secured page</li>
<li>I am just kidding. There&rsquo;s no steps 3.</li>
</ol>
<p>To re-used JWT token in later request, we need to keep in some persistance storage. I pick local storage in Web browser since it&rsquo;s all supported and there are lots of sample using it.
Create the TokentStorage.fs with following code.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> TokenStorage
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> System
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Fable.Import
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> private storageKey <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;token&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> tryGetToken () <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span> option <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Browser.WebStorage.localStorage<span style="color:#f92672">.</span>getItem<span style="color:#f92672">(</span>storageKey<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">function</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">-&gt;</span> None <span style="color:#f92672">|</span> x <span style="color:#f92672">-&gt;</span> Some <span style="color:#f92672">(</span>unbox x<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.bind <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> <span style="color:#66d9ef">if</span> String.IsNullOrWhiteSpace<span style="color:#f92672">(</span>x<span style="color:#f92672">)</span> <span style="color:#66d9ef">then</span> None <span style="color:#66d9ef">else</span> Some x<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> removeToken () <span style="color:#f92672">=</span> Browser.WebStorage.localStorage<span style="color:#f92672">.</span>removeItem<span style="color:#f92672">(</span>storageKey<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> setToken <span style="color:#f92672">(</span>token<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> String.IsNullOrWhiteSpace<span style="color:#f92672">(</span>token<span style="color:#f92672">)</span> <span style="color:#66d9ef">then</span> removeToken()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span> Browser.WebStorage.localStorage<span style="color:#f92672">.</span>setItem<span style="color:#f92672">(</span>storageKey<span style="color:#f92672">,</span> token<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>This module will allow us to get and set token. We will use setToken just for now.
Before that don&rsquo;t forget to add this <code>TokenStorage.fs</code> in Client.fsproj. It should be at the top right below
<code>index.html</code> since all Page need to use it.</p>
<p>Next go to <code>Login.fs</code> and update login flow as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|</span> LoggedIn <span style="color:#f92672">(</span>Ok <span style="color:#f92672">(</span>Token token<span style="color:#f92672">))</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        printf <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Token {token}&#34;</span>
</span></span><span style="display:flex;"><span>        TokenStorage.setToken token
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cmd <span style="color:#f92672">=</span> Cmd.navigatePath<span style="color:#f92672">(</span> <span style="color:#f92672">[|</span><span style="color:#e6db74">&#34;secured&#34;</span><span style="color:#f92672">|])</span>
</span></span><span style="display:flex;"><span>        model<span style="color:#f92672">,</span> cmd
</span></span></code></pre></div><p>We will navigate the path to secured. if you run now the browser will show something like <code>http://localhost.8080/#secured</code> which is not matched with the <code>secured</code> we defined in Saturn. Since by default Saturn use hash navigation which we don&rsquo;t want. We need to change Router as well. Go to <code>Index.fs</code> and change the router to use pathMode instead of the default hashMode.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    React.router <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>        router<span style="color:#f92672">.</span>pathMode
</span></span><span style="display:flex;"><span>        router<span style="color:#f92672">.</span>onUrlChanged <span style="color:#f92672">(</span>parseUrl <span style="color:#f92672">&gt;&gt;</span> UrlChanged <span style="color:#f92672">&gt;&gt;</span> dispatch<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        router<span style="color:#f92672">.</span>children <span style="color:#f92672">[</span> activePage <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">]</span>
</span></span></code></pre></div><p>Now if you login again, you should see same old BoQ page waiting for us.</p>
<figure><img src="/posts/auth-with-jwt/images/login-to-secured-page.png"
    alt="log in to secured page" width="600"><figcaption>
      <h4>Go to Secured page after Logged In</h4>
    </figcaption>
</figure>

<p>Next, we will learn how to authorize each user. Such that only owner of the BoQ can work on it.</p>
<h1 id="credit">Credit<a href="#credit" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<ol>
<li>Saturn JWT example</li>
<li>Ryan Palmer article</li>
</ol>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
