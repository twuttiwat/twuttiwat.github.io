<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>From Scrape To API :: TW Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Converting Scrape Data to Api Introduction TLDR If you prefer just code reading like me, you can skip to the repo
One of the somewhat mundane but necessary tasks in programming is to get data from externa Web sites (a.k.a Web Scraping) and store in easy to use format. These raw data when format properly can be consumed by multiple type of client through Api endpoints.
Since my planned advent of calendar post is not working as I plan. I will challenge myself to see if I can really use F# proficiently or not.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/scrape-2-api/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="From Scrape To API">
<meta property="og:description" content=" Converting Scrape Data to Api Introduction TLDR If you prefer just code reading like me, you can skip to the repo
One of the somewhat mundane but necessary tasks in programming is to get data from externa Web sites (a.k.a Web Scraping) and store in easy to use format. These raw data when format properly can be consumed by multiple type of client through Api endpoints.
Since my planned advent of calendar post is not working as I plan. I will challenge myself to see if I can really use F# proficiently or not.
" />
<meta property="og:url" content="http://localhost:1313/posts/scrape-2-api/" />
<meta property="og:site_name" content="TW Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2023-12-07 14:17:09 &#43;0700 &#43;07" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/scrape-2-api/">From Scrape To API</a>
  </h1>
  <div class="post-meta"><time class="post-date">2023-12-07</time></div>

  
  


  

  <div class="post-content"><div>
        <figure><img src="/posts/scrape-2-api/images/intro-retro.png"
    alt="Intro Retro" width="400"><figcaption>
      <h4>Converting Scrape Data to Api</h4>
    </figcaption>
</figure>

<h2 id="introduction">Introduction<a href="#introduction" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p><strong>TLDR</strong> If you prefer just code reading like me, you can skip to the <a href="https://github.com/twuttiwat/Scrape2Api">repo</a></p>
<p>One of the somewhat mundane but necessary tasks in programming is to get data from externa Web sites (a.k.a Web Scraping) and store in easy to use format. These raw data when format properly can be consumed by multiple type of client through Api endpoints.</p>
<p>Since my planned advent of calendar post is not working as I plan. I will challenge myself to see if I can really use F# proficiently or not.</p>
<p>I love to read tutorial following first principle in that it won&rsquo;t try to give the correct answer upfront. Instead, it will show problem along the way. I ,especially, like to understand what is inside the head of programmer when coding.</p>
<p>This post will follow this style.</p>
<h2 id="background">Background<a href="#background" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>All construction projects require price estimation before start bidding the project. Price for each material comes from Website provided by ministry of commerce. Unfortunately, the website is created in ASP era. (means ActiveX object with ODBC and Oracle). It would be very hard for any client to consume the data.</p>
<p>Your mission is to convert such Web site into Api in one day.</p>
<p>Our starting point is from following website:</p>
<figure><img src="/posts/scrape-2-api/images/start-materials-web.png"
    alt="Start Materials Web" width="600"><figcaption>
      <h4>Materials Price List</h4>
    </figcaption>
</figure>

<p>In fact, we just want following data:</p>
<table>
  <thead>
      <tr>
          <th>Code</th>
          <th>Description</th>
          <th>Unit</th>
          <th>Price</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>0101010107200000</td>
          <td>‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå 300 ‡∏Å‡∏Å./‡∏ï‡∏£.‡∏ã‡∏°. ‡πÅ‡∏•‡∏∞‡∏£‡∏π‡∏õ‡∏ó‡∏£‡∏á‡∏Å‡∏£‡∏∞‡∏ö‡∏≠‡∏Å 250 ‡∏Å‡∏Å./‡∏ï‡∏£.‡∏ã‡∏°. ‡∏ï‡∏£‡∏≤‡∏ã‡∏µ‡πÅ‡∏û‡∏Ñ</td>
          <td>‡∏•‡∏ö.‡∏°.</td>
          <td>2,493.4</td>
      </tr>
  </tbody>
</table>
<p>When entering following curl:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl https://localhost:5051/materials
</span></span></code></pre></div><p>It should return all materials in json array:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span>[ 
</span></span><span style="display:flex;"><span>    {
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">&#34;Code&#34;</span>: <span style="color:#e6db74">&#34;0101010107200000&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Description&#34;</span>: <span style="color:#e6db74">&#34;‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏ö‡∏≤‡∏®‡∏Å‡πå 300 ‡∏Å‡∏Å./‡∏ï‡∏£.‡∏ã‡∏°....&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Unit&#34;</span>: <span style="color:#e6db74">&#34;‡∏•‡∏ö.‡∏°.&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#e6db74">&#34;Price&#34;</span>: <span style="color:#e6db74">&#34;2493.4&#34;</span>
</span></span><span style="display:flex;"><span>    }    
</span></span><span style="display:flex;"><span>]
</span></span></code></pre></div><h2 id="sketch-pipeline">Sketch Pipeline<a href="#sketch-pipeline" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>When starting any F# project, I like to sketch core pipeline to see how data flow from start to end.
Implement each one by one as F# function and combine it at the end.</p>
<ol>
<li>Request page from given url and save in local file system</li>
<li>Parse file into F# Domain type</li>
<li>Store F# type into SQLite + Donald</li>
<li>Create Api Service with Falco</li>
</ol>
<h2 id="requesting-data">Requesting Data<a href="#requesting-data" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>We will start by browsing with <a href="http://www.indexpr.moc.go.th/PRICE_PRESENT/tablecsi_month_region.asp?DDMonth=11&amp;DDYear=2566&amp;DDProvince=10&amp;B1=%B5%A1%C5%A7">materials url</a></p>
<p>Well, if you click the link, you won&rsquo;t get the price list table. Instead, you will see following:</p>
<figure><img src="/posts/scrape-2-api/images/materials-web-blank.png"
    alt="Materials Web Blank" width="600"><figcaption>
      <h4>Initial Url has no Price List</h4>
    </figcaption>
</figure>

<p>Firefox DevTools is your friend here. Press Ctrl-Shift-I, go to Network Tab, and click &lsquo;‡∏ï‡∏Å‡∏•‡∏á&rsquo; (Ok in English) in the Web page.
You will see the price list so clicking on the button should do the trick.
Now, look at below request:</p>
<figure><img src="/posts/scrape-2-api/images/materials-network-request.png"
    alt="Materials Network Request" width="600"><figcaption>
      <h4>View Network Request in Materials Web</h4>
    </figcaption>
</figure>

<p>The request require form data: <strong>DDGroupCode</strong> and <strong>Submit</strong></p>
<p>Let&rsquo;s make our hand (actually keyboard) dirty. Fire up VSCode and create new file call Scratch.fsx.
BTW: I literally copy <a href="https://dev.to/tunaxor/making-http-requests-in-f-1n0b">HttpClient code</a> from Daniel
Thanks! Daniel.</p>
<p>We are going to use HttpClient to Post form data to Url, get the response and save it to file.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> url <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;http://www.indexpr.moc.go.th/PRICE_PRESENT/tablecsi_month_region.asp?DDMonth=11&amp;DDYear=2566&amp;DDProvince=10&amp;B1=%B5%A1%C5%A7&#34;</span>            
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> materialsHtml <span style="color:#f92672">=</span> <span style="color:#e6db74">@&#34;c:/temp/Scrape2Api/materials.html&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> request () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    task <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">use</span> file <span style="color:#f92672">=</span> File.OpenWrite<span style="color:#f92672">(</span>materialsHtml<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Post form data to material url
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">use</span> client <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> HttpClient()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> formData <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">[</span> <span style="color:#e6db74">&#34;DDGroupCode&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">;</span> <span style="color:#e6db74">&#34;Submit&#34;</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;%B5%A1%C5%A7&#34;</span> <span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>k<span style="color:#f92672">,</span> v<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> KeyValuePair<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">string</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;(</span>k<span style="color:#f92672">,</span> v<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> content <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> FormUrlEncodedContent<span style="color:#f92672">(</span>formData<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let!</span> response <span style="color:#f92672">=</span> client<span style="color:#f92672">.</span>PostAsync<span style="color:#f92672">(</span>url<span style="color:#f92672">,</span> content<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Save web page to local file
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> response<span style="color:#f92672">.</span>Content<span style="color:#f92672">.</span>CopyToAsync<span style="color:#f92672">(</span>file<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>   
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Async.AwaitTask
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Async.RunSynchronously 
</span></span></code></pre></div><p>Run following code in fsx file, you should get materials.html in c:\temp\Scratch2Api folder.
We can get raw html file now.</p>
<h2 id="parsing-page">Parsing Page<a href="#parsing-page" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Next task is to parse web page to Material domain type:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Material</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Code<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Description<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Unit<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    UnitPrice<span style="color:#f92672">:</span> <span style="color:#66d9ef">decimal</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>The web is encoded in Windows-874 language, we need to convert to Unicode (UTF-8) wit following funtion:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> toUTF8 sourceFilePath <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read the contents of the file with the source encoding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> sourceEncoding <span style="color:#f92672">=</span> Encoding.GetEncoding<span style="color:#f92672">(</span>874<span style="color:#f92672">)</span> <span style="color:#75715e">// ISO-8859-1 encoding    
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> content <span style="color:#f92672">=</span> File.ReadAllText<span style="color:#f92672">(</span>sourceFilePath<span style="color:#f92672">,</span> sourceEncoding<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write the contents to a new file with the target encoding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">let</span> targetEncoding <span style="color:#f92672">=</span> Encoding.UTF8 <span style="color:#75715e">// UTF-8 encoding
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    File.WriteAllText<span style="color:#f92672">(</span>materialsUtfHtml<span style="color:#f92672">,</span> content<span style="color:#f92672">,</span> targetEncoding<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Personally, I don&rsquo;t like to create new file just for encoding like this. It should be just copy input to output stream and change encoding on the fly. But this is good enough.</p>
<p>We are going to extract html document. I choose class HtmlDocument from FSharp.Data.
The step to extract material row is as follow</p>
<ul>
<li>Extract all TR rows</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> htmlStream <span style="color:#f92672">=</span> File.OpenRead<span style="color:#f92672">(</span>materialsUtfHtml<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> html <span style="color:#f92672">=</span> HtmlDocument.Load<span style="color:#f92672">(</span>htmlStream<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// This will extract all TR elements from HTML document
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> trs <span style="color:#f92672">=</span> html<span style="color:#f92672">.</span>Descendants<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;tr&#34;</span><span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li>Filter out only row containg price at column 4th</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>trs 
</span></span><span style="display:flex;"><span><span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> tr <span style="color:#f92672">-&gt;</span> tr<span style="color:#f92672">.</span>Descendants<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;td&#34;</span><span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> td <span style="color:#f92672">-&gt;</span> td<span style="color:#f92672">.</span>InnerText()<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|&gt;</span> Seq.filter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> tds <span style="color:#f92672">-&gt;</span> tds <span style="color:#f92672">|&gt;</span> Seq.length <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> len <span style="color:#f92672">-&gt;</span> len <span style="color:#f92672">&gt;=</span> 4<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|&gt;</span> Seq.filter <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> tds <span style="color:#f92672">-&gt;</span>                 
</span></span><span style="display:flex;"><span>                    <span style="color:#66d9ef">match</span> tds <span style="color:#f92672">|&gt;</span> Seq.item 3 <span style="color:#f92672">|&gt;</span> System.Decimal.TryParse <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>                    <span style="color:#f92672">|</span> isDecimal<span style="color:#f92672">,</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> isDecimal<span style="color:#f92672">)</span>
</span></span></code></pre></div><ul>
<li>Convert to Material type</li>
</ul>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Material</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Code<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Description<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Unit<span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    UnitPrice<span style="color:#f92672">:</span> <span style="color:#66d9ef">decimal</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Just set each td string into Material field
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> toMaterial <span style="color:#f92672">(</span>tds<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span> seq<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> getText i <span style="color:#f92672">=</span> tds <span style="color:#f92672">|&gt;</span> Seq.item i <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Code <span style="color:#f92672">=</span> getText 0
</span></span><span style="display:flex;"><span>        Description <span style="color:#f92672">=</span> getText 1
</span></span><span style="display:flex;"><span>        Unit <span style="color:#f92672">=</span> getText 2
</span></span><span style="display:flex;"><span>        UnitPrice <span style="color:#f92672">=</span> getText 3 <span style="color:#f92672">|&gt;</span> System.Decimal.Parse  
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span></code></pre></div><h2 id="storing-data">Storing Data<a href="#storing-data" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Phew, we are halfway through the process and I am staring to feel sleepy now.
First, we need to create Material table in SQLite:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-sql" data-lang="sql"><span style="display:flex;"><span><span style="color:#66d9ef">CREATE</span> <span style="color:#66d9ef">TABLE</span> <span style="color:#e6db74">&#34;material&#34;</span> (
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;code&#34;</span>	TEXT,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;description&#34;</span>	TEXT,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;unit&#34;</span>	TEXT,
</span></span><span style="display:flex;"><span>	<span style="color:#e6db74">&#34;unit_price&#34;</span>	NUMERIC,
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">PRIMARY</span> <span style="color:#66d9ef">KEY</span>(<span style="color:#e6db74">&#34;code&#34;</span>)
</span></span><span style="display:flex;"><span>)
</span></span></code></pre></div><p>I prefer to create DTO myself, I will use Donald for this project since I never use it before so why not.
What I like about about Donald and DustyTables are the simplicity of them. I can start by writing raw SQL like this:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// SQL to upsert data into material table
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    INSERT INTO material (code, description, unit, unit_price)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    VALUES (@code, @description, @unit, @unit_price)
</span></span></span><span style="display:flex;"><span><span style="color:#e6db74">    ON CONFLICT do UPDATE SET description = @description, unit = @unit, unit_price = @unit_price&#34;</span><span style="color:#f92672">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// Strongly typed input parameters
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> param <span style="color:#f92672">=</span> <span style="color:#f92672">[</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;code&#34;</span><span style="color:#f92672">,</span> sqlString firstMaterial<span style="color:#f92672">.</span>Code
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;description&#34;</span><span style="color:#f92672">,</span> sqlString firstMaterial<span style="color:#f92672">.</span>Description
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;unit&#34;</span><span style="color:#f92672">,</span> sqlString firstMaterial<span style="color:#f92672">.</span>Unit
</span></span><span style="display:flex;"><span>    <span style="color:#e6db74">&#34;unit_price&#34;</span><span style="color:#f92672">,</span> sqlDecimal firstMaterial<span style="color:#f92672">.</span>UnitPrice
</span></span><span style="display:flex;"><span><span style="color:#f92672">]</span>
</span></span></code></pre></div><p>And just apply it through Donald:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    conn
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Db.newCommand sql
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Db.setParams param
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Db.exec <span style="color:#75715e">// unit
</span></span></span></code></pre></div><h2 id="make-api">Make Api<a href="#make-api" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>I started to like simplicity of Donald so I decide to use Falco as well to see how it fits.
I did create HelloWorldApp in Falco, adding one end point like this.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>EntryPoint<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> main args <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    webHost args <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        endpoints <span style="color:#f92672">[</span>
</span></span><span style="display:flex;"><span>            get <span style="color:#e6db74">&#34;/materials&#34;</span> <span style="color:#f92672">(</span>getAllMaterials ()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    0
</span></span></code></pre></div><p>The handler getAllMaterials will just fetch data from SQLite using Donald.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> getAllMaterials () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">use</span> conn <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> SQLiteConnection<span style="color:#f92672">(</span><span style="color:#e6db74">@&#34;Data Source=C:\Scrape2Api\material.db;Version=3;New=true;&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT code, description, unit, unit_price FROM material&#34;</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    conn
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Db.newCommand sql
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Db.query Material.ofDataReader
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Response.ofJson
</span></span></code></pre></div><p>Of all the component, I found that I like Falco the most. The code are so minimal.</p>
<h2 id="putting-everything-together">Putting Everything Together<a href="#putting-everything-together" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Finally, we are at my most favourite part. Just assemble all the piece together.
All code so far (except Api), is created in Scratch.fsx file.
We need to package everything into application. There are 2 applications for this project</p>
<ol>
<li>Scraper console application which do request, parse, and store data into SQLite.</li>
<li>Material Api will provide Rest api to list all materials information.</li>
</ol>
<h2 id="scraper-console-application">Scraper Console Application<a href="#scraper-console-application" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>This is versy simple just create new F# console project. Add necessary package and add following function.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> scrape () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    request ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> toUTF8
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> parse
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> saveToDb
</span></span></code></pre></div><p>We just pipe all function we have so far into one single <strong>scrape</strong> function. To protect the data server, we will run just once a day.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>async <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> oneDay <span style="color:#f92672">=</span> 1000 <span style="color:#f92672">*</span> 60 <span style="color:#f92672">*</span> 60 <span style="color:#f92672">*</span> 24    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">true</span> <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span> scrape ()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> Async.Sleep oneDay
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|&gt;</span> Async.RunSynchronously
</span></span></code></pre></div><p>Running the scraper should create material.db database in &ldquo;C:\temp\Scrape2Api&quot;</p>
<figure><img src="/posts/scrape-2-api/images/done-scraping.png"
    alt="Done Scraping" width="300"><figcaption>
      <h4>Result of Scraping</h4>
    </figcaption>
</figure>

<h2 id="material-api">Material Api<a href="#material-api" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Since all the function has been implemented in test project. Just move that project into solution and it&rsquo;s done.</p>
<p>And here my small moment of truth:</p>
<figure><img src="/posts/scrape-2-api/images/done-api.png"
    alt="Done Api" width="600"><figcaption>
      <h4>Material Api</h4>
    </figcaption>
</figure>

<h2 id="conclusion">Conclusion<a href="#conclusion" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Whew, I really finish scrape data and convert to api in one day. The most time-consuming part is the parsing since you somehow need to know the existing logic. The rest is very simple especially creating Api with Falco. I plan to try Falco web framework in my next side project.</p>
<p>Happy X&rsquo;Mas!!
Hope this year will be have more lambda to apply! üòÑ</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>¬© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
