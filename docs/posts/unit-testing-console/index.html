<!DOCTYPE html>
<html lang="en" dir="auto">

<head>
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8W769DNB5L"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8W769DNB5L');
</script>
    <meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Unit Testing and Console Application | TW Blog</title>
<meta name="keywords" content="">
<meta name="description" content="Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.
This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.
So many things to do in this post, let&rsquo;s start&hellip;
Class Library Since we are going to create real application this time, we should create our solution before creating any project.">
<meta name="author" content="Teerawat Wuttiwat">
<link rel="canonical" href="https://twuttiwat.github.io/posts/unit-testing-console/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://twuttiwat.github.io/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://twuttiwat.github.io/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://twuttiwat.github.io/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://twuttiwat.github.io/apple-touch-icon.png">
<link rel="mask-icon" href="https://twuttiwat.github.io/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="Unit Testing and Console Application" />
<meta property="og:description" content="Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.
This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.
So many things to do in this post, let&rsquo;s start&hellip;
Class Library Since we are going to create real application this time, we should create our solution before creating any project." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://twuttiwat.github.io/posts/unit-testing-console/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2022-11-19T11:57:43+07:00" />
<meta property="article:modified_time" content="2022-11-19T11:57:43+07:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Unit Testing and Console Application"/>
<meta name="twitter:description" content="Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.
This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.
So many things to do in this post, let&rsquo;s start&hellip;
Class Library Since we are going to create real application this time, we should create our solution before creating any project."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://twuttiwat.github.io/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Unit Testing and Console Application",
      "item": "https://twuttiwat.github.io/posts/unit-testing-console/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Unit Testing and Console Application",
  "name": "Unit Testing and Console Application",
  "description": "Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.\nThis week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.\nSo many things to do in this post, let\u0026rsquo;s start\u0026hellip;\nClass Library Since we are going to create real application this time, we should create our solution before creating any project.",
  "keywords": [
    
  ],
  "articleBody": "Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.\nThis week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.\nSo many things to do in this post, let’s start…\nClass Library Since we are going to create real application this time, we should create our solution before creating any project. I like to use command line so I follow script from Ian Russel as follow:\ndotnet new sln -o CoCoTender dotnet new gitignore cd CoCoTender mkdir src cd src dotnet new classlib -lang F# -o CoCoTender.Domain cd .. dotnet sln add src/CoCoTender.Domain dotnet build There should be no error after you run ‘dotnet build’ command. Also, I did create gitignore for entire solution by using nifty dotnet new command. That’s awesome.\nLike what we did in the past, we will do it one by one.\nCopy BoQItem module from scratch.fsx file to Library.fs. Here is the code: namespace CoCoTender.Domain type Quantity = Quantity of float*string type UnitCost = { Name : string UnitCost : float Unit : string } type MaterialUnitCost = Material of UnitCost type LaborUnitCost = Labor of UnitCost type BoQItem = private { Description : string Quantity : Quantity MaterialUnitCost : MaterialUnitCost LaborUnitCost : LaborUnitCost TotalCost : float } module BoQItem = let calcCost qty unitCost = match qty, unitCost with | Quantity (qty, qtyUnit), {UnitCost = unitCost; Unit = unitCostUnit} when qtyUnit = unitCostUnit -\u003e (qty * unitCost) |\u003e Some | _ -\u003e None let tryCalcItemCost qty (Material materialUnitCost) (Labor laborUnitCost) = match calcCost qty materialUnitCost, calcCost qty laborUnitCost with | Some materialCost, Some laborCost -\u003e Some (materialCost + laborCost) | _ -\u003e None let isValid desc qty materialUnitCost laborUnitCost = match qty, materialUnitCost, laborUnitCost with | Quantity (_, qtyUnit), Material {Unit = materialUnit}, Labor {Unit = laborUnit} -\u003e qtyUnit = materialUnit \u0026\u0026 qtyUnit = laborUnit let tryCreate desc qty materialUnitCost laborUnitCost = if isValid desc qty materialUnitCost laborUnitCost then tryCalcItemCost qty materialUnitCost laborUnitCost |\u003e Option.map(fun cost -\u003e { Description = desc Quantity = qty MaterialUnitCost = materialUnitCost LaborUnitCost = laborUnitCost TotalCost = cost }) else None let value item = {| Description = item.Description Quantity = item.Quantity MaterialUnitCost = item.MaterialUnitCost LaborUnitCost = item.LaborUnitCost TotalCost = item.TotalCost |} It’s the exact same code as script file. Just add namespace CoCoTender.Domain at the top.\nNext, we need to move our test code from our script file to unit testing project. Here is the command to create the project.\nmkdir tests cd tests dotnet new xunit -lang F# -o CoCoTender.DomainTests dotnet add reference ../../src/CoCoTender.Domain dotnet add package FsUnit dotnte add Package FsUnit.XUnit cd .. dotnet sln add tests/CoCoTender.DomainTests dotnet test The result should show that all tests are passed. Let’s create our firs test.\nmodule Tests open System open Xunit open FsUnit open CoCoTender open CoCoTender.Domain module ``Create boq item`` = let desc = \"Pool Item\" let qty = Quantity (10.0, \"m^2\") let material = Material { Name = \"Big Tile\"; UnitCost = 100.0; Unit = \"m^2\" } let labor = Labor { Name = \"Do Tiling\"; UnitCost = 50.0; Unit = \"m^2\" } let totalCost = 10*100 + 10*50 [\u003cFact\u003e] let ``should succeed if Quantity, Material and Labor use the same Unit`` () = let result = BoQItem.tryCreate desc qty material labor match result with | Some item -\u003e let itemVal = item |\u003e BoQItem.value itemVal.Description |\u003e should equal desc itemVal.Quantity |\u003e should equal qty itemVal.MaterialUnitCost |\u003e should equal material itemVal.LaborUnitCost |\u003e should equal labor | None -\u003e Assert.Fail \"Could not create BoQItem\" [\u003cFact\u003e] let ``should fail if Quantity, Material and Labor have different Units`` () = let material' = material |\u003e fun (Material m) -\u003e {m with Unit = \"m\"} |\u003e Material let labor' = labor |\u003e fun (Labor l) -\u003e {l with Unit = \"cm\"} |\u003e Labor let result = BoQItem.tryCreate desc qty material' labor' match result with | None -\u003e Assert.True(true) | Some _ -\u003e Assert.Fail \"Should not create BoQItem with different Unit\" [\u003cFact\u003e] let ``should always calculate total cost when create`` () = let result = BoQItem.tryCreate desc qty material labor match result with | Some item -\u003e let itemVal = item |\u003e BoQItem.value itemVal.TotalCost |\u003e should equal totalCost | None -\u003e Assert.Fail \"Could not create BoQItem\" There are 3 tests we want to verify when creating boq item.\nIt should succeeded when all units are matched. It should failed when some units are not matched. It should always calculate total cost when create new item. Run\ndotnet test To see if all tests are passed.\nWe are done with item creation logic. Next, we will add updating boq function from the database.\nlet updateDesc newDesc item = { item with Description = newDesc } let tryUpdateQty newQty item = tryCalcItemCost newQty item.MaterialUnitCost item.LaborUnitCost |\u003e Option.map (fun cost -\u003e { item with Quantity = newQty TotalCost = cost }) let tryUpdateMaterialUnitCost (Material newUnitCost) item = let newMaterialUnitCost = Material newUnitCost tryCalcItemCost item.Quantity newMaterialUnitCost item.LaborUnitCost |\u003e Option.map (fun cost -\u003e { item with MaterialUnitCost = newMaterialUnitCost TotalCost = cost }) let tryUpdateLaborUnitCost (Labor newUnitCost) item = let newLaborUnitCost = Labor newUnitCost tryCalcItemCost item.Quantity item.MaterialUnitCost newLaborUnitCost |\u003e Option.map (fun cost -\u003e { item with LaborUnitCost = newLaborUnitCost TotalCost = cost }) Don’t forget to build the library first before create another unit tests. But the ionide extension should show any error immediately without compilation though.\nHere is the unit tests for the update functions:\nmodule ``Update boq item`` = let desc = \"Pool Item\" let qty = Quantity (10.0, \"m^2\") let material = Material { Name = \"Big Tile\"; UnitCost = 100.0; Unit = \"m^2\" } let labor = Labor { Name = \"Do Tiling\"; UnitCost = 50.0; Unit = \"m^2\" } let item = match BoQItem.tryCreate desc qty material labor with | Some item' -\u003e item' | _ -\u003e failwith \"Could not create item for updating\" let totalCost = item |\u003e BoQItem.value |\u003e fun x -\u003e x.TotalCost [\u003cFact\u003e] let ``with quantity should always re-calculate total cost`` () = let result = item |\u003e BoQItem.tryUpdateQty (Quantity (20, \"m^2\")) match result with | Some item' -\u003e let itemVal' = item' |\u003e BoQItem.value itemVal'.TotalCost |\u003e should equal (totalCost * 2.0) | _ -\u003e Assert.Fail \"Could not update quantity\" [\u003cFact\u003e] let ``with description should not update total cost`` () = let result = item |\u003e BoQItem.updateDesc \"New Pool\" let resultVal = result |\u003e BoQItem.value resultVal.TotalCost |\u003e should equal totalCost The explanation in function name should be suffice. What we want here is to make sure that whenever there are changes in boq item, recalculation should occur.\nThe last unit testing is for estimating total cost of the project.\nmodule ``Estimate construction cost`` = open Project let loadFactorFTableFn = function () -\u003e FactorFTable [(10,1.1); (100,1.5); (1000, 1.9)] [\u003cFact\u003e] let ``should return correct result`` () = let result = estimateCost loadFactorFTableFn [item] result |\u003e should equal 2000 [\u003cFact\u003e] let ``should not round when less than one thousand`` () = let smallPool = match item |\u003e BoQItem.tryUpdateQty (Quantity (1.0, \"m^2\")) with | Some item' -\u003e item' | _ -\u003e failwith \"Could not update quantity\" let result = estimateCost loadFactorFTableFn [smallPool] result |\u003e should (equalWithin 0.11) 228.33 As you can see, all test functions are originated from our script file. We just organice into module and function to make the intention of the tests clearer.\nConsole I found that it’s best to show tangible result to the users as soon as I can. Since, creating whole webapp might take too long at this stage. So I think it’s best to start with just console application.\nThe goal of this console is to let client test the input. The input should be easy for client to create and at the same time should not take too long for us to code. I think Csv files are the optimal choice for this since it is very easy to create using just Excel or Google Sheet. Also there are f# type provider just for this.\nThe input files we are going to create for testing are for BoQ item and Factor F table. Here is the format of these 2 files:\nBoQ Items\nDescription Quantity Unit Material MaterialUnit MaterialUnitCost Labor LaborUnit LaborUnitCost Pool Tile 10 m^2 Big Tile m^2 100 Do Tiling m^2 50 Factor F Table\nDirectCost FactorF 10 1.1 100 1.5 1000 1.9 Again, we will start with fsx script.\n#r \"nuget: FSharp.Data, 5.0.2\" #r @\"C:\\projs\\CoCoTender\\src\\CoCoTender.Domain\\bin\\Debug\\net6.0\\CoCoTender.Domain.dll\" open FSharp.Data open CoCoTender.Domain open BoQItem open Project [\u003cLiteral\u003e] let ResolutionFolder = __SOURCE_DIRECTORY__ type BoQItems = CsvProvider\u003c\"boq.csv\", ResolutionFolder=ResolutionFolder\u003e let toBoQItem (row:BoQItems.Row) = let qty = Quantity (row.Quantity, row.Unit.Trim()) let material = { Name = row.Material Unit = row.MaterialUnit.Trim() UnitCost = row.MaterialUnitCost } |\u003e Material let labor = { Name = row.Labor Unit = row.LaborUnit.Trim() UnitCost = row.LaborUnitCost } |\u003e Labor BoQItem.tryCreate row.Description qty material labor let loadBoQFile (filePath:string) = BoQItems .Load(__SOURCE_DIRECTORY__ + \"/boq.csv\") .Rows |\u003e Seq.choose toBoQItem |\u003e List.ofSeq open Project type FactorFFile = CsvProvider\u003c\"FactorF.csv\", ResolutionFolder=ResolutionFolder\u003e let loadFactorFFile (filePath:string) () = FactorFFile .Load(filePath) .Rows |\u003e Seq.map (fun x -\u003e x.DirectCost,x.FactorF) |\u003e List.ofSeq |\u003e FactorFTable let boqFile = __SOURCE_DIRECTORY__ + \"/boq.csv\" let factorFFile = __SOURCE_DIRECTORY__ + \"/FactorF.csv\" let cost = estimateCost (loadFactorFFile factorFFile) (loadBoQFile boqFile) match fsi.CommandLineArgs |\u003e List.ofArray with | _::boqFile::factorFFile::_ -\u003e let cost = estimateCost (loadFactorFFile factorFFile) (loadBoQFile boqFile) printfn $\"Estimate Cost is {cost}\" | _::_ -\u003e let boqFile = __SOURCE_DIRECTORY__ + @\"\\boq.csv\" let factorFFile = __SOURCE_DIRECTORY__ + @\"\\FactorF.csv\" printfn \"%s\" boqFile printfn \"%s\" factorFFile let cost = estimateCost (loadFactorFFile factorFFile) (loadBoQFile boqFile) printfn $\"Estimate Cost is {cost}\" | _ -\u003e printfn \"Should not be here\" We use Csv Type Provider to read data from csv files and transform each csv row to designated type (BoQItem and FactorFTable). The domain code could be referenced in the script by referring to the class library dll (CoCoTender.Domain.dll). The transformation is straightforward, so I will skip that.\nThe interesting bit of code is the way that we can actually create console application by just using script file. The fsi.CommandLineArgs will read argument from the command line. For simplicity, we will assume that the first argument will be the path to boq item file and the second one will be for factor f file. If user does not specify the path, we will just use the default one\nWe can test this script by running following command\ndotnet fsi scratch.fsx The result should be the same as unit test since we use the same test data.\nNow we are ready to create actual console application. Type following commands to create console project.\ncd src dotnet new console -lang F# -o CoCoTender.Console cd CoCoTender.Console dotnet add reference ../CoCoTender.Domain dotnet add package FSharp.Data Then you just need to copy the code from fsx file to Program.fs. Here is the final result:\nopen System.IO open FSharp.Data open CoCoTender.Domain open BoQItem open Project [\u003cLiteral\u003e] // let ResolutionFolder = @\"c:/projs/CoCoTender/src/scripts/\"// __SOURCE_DIRECTORY__ let ResolutionFolder = __SOURCE_DIRECTORY__ module BoQFile = type BoQItems = CsvProvider\u003c\"boq.csv\", ResolutionFolder=ResolutionFolder\u003e let toBoQItem (row:BoQItems.Row) = let qty = Quantity (row.Quantity, row.Unit.Trim()) let material = { Name = row.Material Unit = row.MaterialUnit.Trim() UnitCost = row.MaterialUnitCost } |\u003e Material let labor = { Name = row.Labor Unit = row.LaborUnit.Trim() UnitCost = row.LaborUnitCost } |\u003e Labor BoQItem.tryCreate row.Description qty material labor let load (filePath:string) = BoQItems .Load(filePath) .Rows |\u003e Seq.choose toBoQItem |\u003e List.ofSeq module FactorFFile = type FactorFs = CsvProvider\u003c\"FactorF.csv\", ResolutionFolder=ResolutionFolder\u003e let load (filePath:string) () = FactorFs .Load(filePath) .Rows |\u003e Seq.map (fun x -\u003e x.DirectCost,x.FactorF) |\u003e List.ofSeq |\u003e FactorFTable [\u003cEntryPoint\u003e] let main args = printfn \"%A\" args match args |\u003e List.ofArray with | boqFile::factorFFile::_ -\u003e let cost = estimateCost (FactorFFile.load factorFFile) (BoQFile.load boqFile) printfn $\"Estimate Cost is {cost}\" | [] -\u003e let boqFile = \"boq.csv\" let factorFFile = \"factorf.csv\" printfn \"%s\" boqFile printfn \"%s\" factorFFile let cost = estimateCost (FactorFFile.load factorFFile) (BoQFile.load boqFile) printfn $\"Estimate Cost is {cost}\" | _ -\u003e printfn \"Should not be here\" 0 Let’s try running the console:\ndotnet run boq.csv factorf.csv I show the application to the domain expert and let their play with the program.\nExpert: Can I create boq item with invalid data? Such as having item with different unit? Me: Sure, if you do that those line will be skipped. Expert: Hmmm, I don’t think that’s right. User should immediately see the problem.\nYou might felt bad about not creating the right solution for the client in the first place. But don’t worry, this way of showing immediate feed back to the client (aka. REPL on steroid) is so much better for both developer and the users of the system. Since, all the misunderstanding could be cleared out in days; not weeks, or even months.\nMe: We can fix that. Should I show the error for that line in particular? Expert: We would like to see the whole error. It should show all the error for each line. So the user can fix all of them before re-estimate the data.\nWhat we need to do is to keep error message for each items if any and show them. If there is no error, we just return the estimated code. This is where FsErrorToolkit comes to play.\nFsErrorToolKit I really like railway-oriented programming style. I think it’s straightforward and can blend well with function programming style. Recently, F# has already include Result type into the core language. But I heard many good things from library FsErrorToolkit. So I will give it a shot for this project.\nBefore using the toolking in the Domain library, it’s often a good idea to pivot any library with fsx script first. Here is my plan of introducing new code to fsharp solution.\nTry out in fsx script Change the actual code Change unit testing Start by copying the code from Domain to fsx file and change the most outer function (estimateCost) to use Result type and gradually change from there.\nlet estimateCost' loadFactorFTable = calcDirectCost \u003e\u003e (applyFactorF loadFactorFTable) \u003e\u003e roundCost let estimateCost loadFactorFTable items = let cost = estimateCost' loadFactorFTable items Ok cost Since this function has no error, so we just return cost with Ok constructor. How about the one that can cause error like creating boq item. Previously, if we could not create item, we just return None. But now we want to return Error with helpful message instead.\nlet areUnitsMatched qty materialUnitCost laborUnitCost = match qty, materialUnitCost, laborUnitCost with | Quantity (_, qtyUnit), Material {Unit = materialUnit}, Labor {Unit = laborUnit} -\u003e qtyUnit = materialUnit \u0026\u0026 qtyUnit = laborUnit let tryRecalcTotalCost item = let calcTotalCost() = match item.Quantity, item.MaterialUnitCost, item.LaborUnitCost with | Quantity (qty,_), Material {UnitCost = mUnitCost}, Labor {UnitCost = lbUnitCost} -\u003e (qty * mUnitCost) + (qty * lbUnitCost) result { do! areUnitsMatched item.Quantity item.MaterialUnitCost item.LaborUnitCost |\u003e Result.requireTrue \"Unit are Not matched.\" return { item with TotalCost = calcTotalCost() } } let tryCreate desc qty materialUnitCost laborUnitCost = result { do! areUnitsMatched qty materialUnitCost laborUnitCost |\u003e Result.requireTrue \"Unit are Not matched.\" let! item = { Description = desc Quantity = qty MaterialUnitCost = materialUnitCost LaborUnitCost = laborUnitCost TotalCost = 0.0 } |\u003e tryRecalcTotalCost return item } This requires some explanations. Function try create is inside result computation expression which means that when any error occurs, execution will return from the function immediately. This way of coding significantly remove boiler plat code. The intention is much clearer but at the same time, it comes with cause of understanding what CE (computation expression) is. But I think it’s worthwhile.\nHere we go for tryCreate:\nCheck if areUnitsMatched function which return boolean. If the validation function return false, return from CE immediately with error message “Unit are Not matched”. Recalculate the total cost. See that we use let! when calling function returning result type (tryRecalcTotalCost in this case) After checking that the new script with result CE works as expected, just copy the code to Library.fs file. Don’t forget to add the toolkit to the project.\ncd src\\CoCoTender.Domain dotnet add package FsErrorToolKit.ErrorHandling We need to change the Test project to use Result type as well. Here is an example for creating boq item test:\n[\u003cFact\u003e] let ``should succeed if Quantity, Material and Labor use the same Unit`` () = let result = BoQItem.create desc qty material labor match result with | Ok item -\u003e let itemVal = item |\u003e BoQItem.value itemVal.Description |\u003e should equal desc itemVal.Quantity |\u003e should equal qty itemVal.MaterialUnitCost |\u003e should equal material itemVal.LaborUnitCost |\u003e should equal labor | Error msg -\u003e Assert.Fail msg We just need to match the result with Ok and Error. Finally, we are almost at the end of this post. The only thing left is to update the Console application to use Result type. The only function that require understanding is the load function for BoQ item.\nlet load (filePath:string) = BoQItems .Load(filePath) .Rows |\u003e Seq.map toBoQItem |\u003e List.ofSeq |\u003e List.sequenceResultA |\u003e function | Ok items -\u003e items | Error msgs -\u003e failwith $\"{msgs}\" Remember that the expert wants the error for each boq item (if any). After we map toBoQItem for each row, we will get sequence of Result type. But what we really want is just one Result with a list of Ok or Error instead. For example, if there are 2 error after load boq item. We want to have result as Error [ “error msg1”; “error msg2” ]. All of this can be accomplished by List.sequenceResultA provided by the toolkit.\nIf there are any error, the program will fail and show list of error messages.\nIt’s all done for this post now. You can get the code for this post by clone with tag v0.2.0. Till next time!\n",
  "wordCount" : "2941",
  "inLanguage": "en",
  "datePublished": "2022-11-19T11:57:43+07:00",
  "dateModified": "2022-11-19T11:57:43+07:00",
  "author":{
    "@type": "Person",
    "name": "Teerawat Wuttiwat"
  },
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://twuttiwat.github.io/posts/unit-testing-console/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "TW Blog",
    "logo": {
      "@type": "ImageObject",
      "url": "https://twuttiwat.github.io/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://twuttiwat.github.io/" accesskey="h" title="TW Blog (Alt + H)">TW Blog</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title">
      Unit Testing and Console Application
    </h1>
    <div class="post-meta"><span title='2022-11-19 11:57:43 +0700 +07'>November 19, 2022</span>&nbsp;·&nbsp;Teerawat Wuttiwat

</div>
  </header> 
  <div class="post-content"><p>Good day. Sorry, I am back after busy weeks.
To bring back our past weeks, we did finish domain modeling in fsx file.</p>
<p>This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.</p>
<p>So many things to do in this post, let&rsquo;s start&hellip;</p>
<h1 id="class-library">Class Library<a hidden class="anchor" aria-hidden="true" href="#class-library">#</a></h1>
<p>Since we are going to create real application this time, we should create our solution before creating any project. I like to use command line so I follow script from Ian Russel as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet new sln -o CoCoTender
</span></span><span style="display:flex;"><span>dotnet new gitignore
</span></span><span style="display:flex;"><span>cd CoCoTender
</span></span><span style="display:flex;"><span>mkdir src
</span></span><span style="display:flex;"><span>cd src
</span></span><span style="display:flex;"><span>dotnet new classlib -lang F# -o CoCoTender.Domain
</span></span><span style="display:flex;"><span>cd ..
</span></span><span style="display:flex;"><span>dotnet sln add src/CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet build
</span></span></code></pre></div><p>There should be no error after you run &lsquo;dotnet build&rsquo; command.
Also, I did create gitignore for entire solution by using nifty dotnet new command. That&rsquo;s awesome.</p>
<p>Like what we did in the past, we will do it one by one.</p>
<ol>
<li>Copy BoQItem module from scratch.fsx file to Library.fs.
Here is the code:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Quantity</span> <span style="color:#f92672">=</span> Quantity <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UnitCost</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Name <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    UnitCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>    Unit <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MaterialUnitCost</span> <span style="color:#f92672">=</span> Material <span style="color:#66d9ef">of</span> UnitCost
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LaborUnitCost</span> <span style="color:#f92672">=</span> Labor <span style="color:#66d9ef">of</span> UnitCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItem</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">private</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Description <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Quantity <span style="color:#f92672">:</span> Quantity
</span></span><span style="display:flex;"><span>    MaterialUnitCost <span style="color:#f92672">:</span> MaterialUnitCost
</span></span><span style="display:flex;"><span>    LaborUnitCost <span style="color:#f92672">:</span> LaborUnitCost
</span></span><span style="display:flex;"><span>    TotalCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> BoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> calcCost qty unitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> unitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(</span>qty<span style="color:#f92672">,</span> qtyUnit<span style="color:#f92672">),</span> <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> unitCost<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> unitCostUnit<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">when</span> qtyUnit <span style="color:#f92672">=</span> unitCostUnit <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> unitCost<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> Some
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCalcItemCost qty <span style="color:#f92672">(</span>Material materialUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Labor laborUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> calcCost qty materialUnitCost<span style="color:#f92672">,</span> calcCost qty laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Some materialCost<span style="color:#f92672">,</span> Some laborCost <span style="color:#f92672">-&gt;</span> Some <span style="color:#f92672">(</span>materialCost <span style="color:#f92672">+</span> laborCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> isValid desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> materialUnitCost<span style="color:#f92672">,</span> laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(_,</span> qtyUnit<span style="color:#f92672">),</span> Material <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> materialUnit<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> laborUnit<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      qtyUnit <span style="color:#f92672">=</span> materialUnit <span style="color:#f92672">&amp;&amp;</span> qtyUnit <span style="color:#f92672">=</span> laborUnit  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCreate desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isValid desc qty materialUnitCost laborUnitCost  <span style="color:#66d9ef">then</span> 
</span></span><span style="display:flex;"><span>      tryCalcItemCost qty materialUnitCost laborUnitCost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> Option.map<span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          Description <span style="color:#f92672">=</span> desc
</span></span><span style="display:flex;"><span>          Quantity <span style="color:#f92672">=</span> qty
</span></span><span style="display:flex;"><span>          MaterialUnitCost <span style="color:#f92672">=</span> materialUnitCost
</span></span><span style="display:flex;"><span>          LaborUnitCost <span style="color:#f92672">=</span> laborUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> value item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{|</span> 
</span></span><span style="display:flex;"><span>      Description <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>Description
</span></span><span style="display:flex;"><span>      Quantity <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>Quantity
</span></span><span style="display:flex;"><span>      MaterialUnitCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>      LaborUnitCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>      TotalCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>TotalCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|}</span>
</span></span></code></pre></div><p>It&rsquo;s the exact same code as script file. Just add namespace CoCoTender.Domain at the top.</p>
<p>Next, we need to move our test code from our script file to unit testing project. Here is the command to create the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir tests
</span></span><span style="display:flex;"><span>cd tests
</span></span><span style="display:flex;"><span>dotnet new xunit -lang F# -o CoCoTender.DomainTests
</span></span><span style="display:flex;"><span>dotnet add reference ../../src/CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FsUnit
</span></span><span style="display:flex;"><span>dotnte add Package FsUnit.XUnit
</span></span><span style="display:flex;"><span>cd ..
</span></span><span style="display:flex;"><span>dotnet sln add tests/CoCoTender.DomainTests
</span></span><span style="display:flex;"><span>dotnet test
</span></span></code></pre></div><p>The result should show that all tests are passed.
Let&rsquo;s create our firs test.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Tests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> System
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Xunit
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FsUnit
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Create boq item`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Item&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Big Tile&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> totalCost <span style="color:#f92672">=</span> 10<span style="color:#f92672">*</span>100 <span style="color:#f92672">+</span> 10<span style="color:#f92672">*</span>50
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should succeed if Quantity, Material and Labor use the same Unit`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Description <span style="color:#f92672">|&gt;</span> should equal desc
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Quantity <span style="color:#f92672">|&gt;</span> should equal qty
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>MaterialUnitCost <span style="color:#f92672">|&gt;</span> should equal material
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> should equal labor
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not create BoQItem&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should fail if Quantity, Material and Labor have different Units`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> material <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>Material m<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>m <span style="color:#66d9ef">with</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> labor <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>Labor l<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>l <span style="color:#66d9ef">with</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cm&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material&#39; labor&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.True<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Should not create BoQItem with different Unit&#34;</span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should always calculate total cost when create`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal totalCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not create BoQItem&#34;</span> 
</span></span></code></pre></div><p>There are 3 tests we want to verify when creating boq item.</p>
<ol>
<li>It should succeeded when all units are matched.</li>
<li>It should failed when some units are not matched.</li>
<li>It should always calculate total cost when create new item.</li>
</ol>
<p>Run</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet test
</span></span></code></pre></div><p>To see if all tests are passed.</p>
<p>We are done with item creation logic. Next, we will add updating boq function from the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> updateDesc newDesc item <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> item <span style="color:#66d9ef">with</span> Description <span style="color:#f92672">=</span> newDesc <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateQty newQty item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    tryCalcItemCost newQty item<span style="color:#f92672">.</span>MaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          Quantity <span style="color:#f92672">=</span> newQty
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateMaterialUnitCost <span style="color:#f92672">(</span>Material newUnitCost<span style="color:#f92672">)</span> item <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> newMaterialUnitCost <span style="color:#f92672">=</span> Material newUnitCost
</span></span><span style="display:flex;"><span>    tryCalcItemCost item<span style="color:#f92672">.</span>Quantity newMaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          MaterialUnitCost <span style="color:#f92672">=</span> newMaterialUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateLaborUnitCost <span style="color:#f92672">(</span>Labor newUnitCost<span style="color:#f92672">)</span> item <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> newLaborUnitCost <span style="color:#f92672">=</span> Labor newUnitCost
</span></span><span style="display:flex;"><span>    tryCalcItemCost item<span style="color:#f92672">.</span>Quantity item<span style="color:#f92672">.</span>MaterialUnitCost newLaborUnitCost 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          LaborUnitCost <span style="color:#f92672">=</span> newLaborUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to build the library first before create another unit tests. But the ionide extension should show any error immediately without compilation though.</p>
<p>Here is the unit tests for the update functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Update boq item`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Item&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Big Tile&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> BoQItem.tryCreate desc qty material labor <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> item&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;Could not create item for updating&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> totalCost <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>TotalCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``with quantity should always re-calculate total cost`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdateQty <span style="color:#f92672">(</span>Quantity <span style="color:#f92672">(</span>20<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> item&#39; <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal&#39;<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal <span style="color:#f92672">(</span>totalCost <span style="color:#f92672">*</span> 2<span style="color:#f92672">.</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not update quantity&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``with description should not update total cost`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.updateDesc <span style="color:#e6db74">&#34;New Pool&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> resultVal <span style="color:#f92672">=</span> result <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>        resultVal<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal totalCost
</span></span></code></pre></div><p>The explanation in function name should be suffice. What we want here is to make sure that whenever there are changes in boq item, recalculation should occur.</p>
<p>The last unit testing is for estimating total cost of the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Estimate construction cost`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> loadFactorFTableFn <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span> () <span style="color:#f92672">-&gt;</span> FactorFTable <span style="color:#f92672">[(</span>10<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>1<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>100<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>5<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>1000<span style="color:#f92672">,</span> 1<span style="color:#f92672">.</span>9<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should return correct result`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> estimateCost loadFactorFTableFn <span style="color:#f92672">[</span>item<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|&gt;</span> should equal 2000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should not round when less than one thousand`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> smallPool <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> item <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdateQty <span style="color:#f92672">(</span>Quantity <span style="color:#f92672">(</span>1<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">))</span> <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> item&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;Could not update quantity&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> estimateCost loadFactorFTableFn <span style="color:#f92672">[</span>smallPool<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|&gt;</span> should <span style="color:#f92672">(</span>equalWithin 0<span style="color:#f92672">.</span>11<span style="color:#f92672">)</span> 228<span style="color:#f92672">.</span>33
</span></span></code></pre></div><p>As you can see, all test functions are originated from our script file. We just organice into module and function to make the intention of the tests clearer.</p>
<h1 id="console">Console<a hidden class="anchor" aria-hidden="true" href="#console">#</a></h1>
<p>I found that it&rsquo;s best to show tangible result to the users as soon as I can. Since, creating whole webapp might take too long at this stage. So I think it&rsquo;s best to start with just console application.</p>
<p>The goal of this console is to let client test the input. The input should be easy for client to create and at the same time should not take too long for us to code. I think Csv files are the optimal choice for this since it is very easy to create using just Excel or Google Sheet. Also there are f# type provider just for this.</p>
<p>The input files we are going to create for testing are for BoQ item and Factor F table.
Here is the format of these 2 files:</p>
<p>BoQ Items</p>
<table>
<thead>
<tr>
<th>Description</th>
<th>Quantity</th>
<th>Unit</th>
<th>Material</th>
<th>MaterialUnit</th>
<th>MaterialUnitCost</th>
<th>Labor</th>
<th>LaborUnit</th>
<th>LaborUnitCost</th>
</tr>
</thead>
<tbody>
<tr>
<td>Pool Tile</td>
<td>10</td>
<td>m^2</td>
<td>Big Tile</td>
<td>m^2</td>
<td>100</td>
<td>Do Tiling</td>
<td>m^2</td>
<td>50</td>
</tr>
</tbody>
</table>
<p>Factor F Table</p>
<table>
<thead>
<tr>
<th>DirectCost</th>
<th>FactorF</th>
</tr>
</thead>
<tbody>
<tr>
<td>10</td>
<td>1.1</td>
</tr>
<tr>
<td>100</td>
<td>1.5</td>
</tr>
<tr>
<td>1000</td>
<td>1.9</td>
</tr>
</tbody>
</table>
<p>Again, we will start with fsx script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">&#34;nuget: FSharp.Data, 5.0.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">@&#34;C:\projs\CoCoTender\src\CoCoTender.Domain\bin\Debug\net6.0\CoCoTender.Domain.dll&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FSharp.Data
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> BoQItem
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>Literal<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> ResolutionFolder <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItems</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;boq.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> toBoQItem <span style="color:#f92672">(</span>row<span style="color:#f92672">:</span>BoQItems.Row<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>row<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> row<span style="color:#f92672">.</span>Unit<span style="color:#f92672">.</span>Trim()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Material
</span></span><span style="display:flex;"><span>        Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>        UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Labor
</span></span><span style="display:flex;"><span>      Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>      UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  BoQItem.tryCreate row<span style="color:#f92672">.</span>Description qty material labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> loadBoQFile <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  BoQItems
</span></span><span style="display:flex;"><span>    .Load<span style="color:#f92672">(__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/boq.csv&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> Seq.choose toBoQItem 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FactorFFile</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;FactorF.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> loadFactorFFile <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>  FactorFFile
</span></span><span style="display:flex;"><span>    .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> List.ofSeq 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> FactorFTable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/boq.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/FactorF.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">match</span> fsi<span style="color:#f92672">.</span>CommandLineArgs <span style="color:#f92672">|&gt;</span> List.ofArray <span style="color:#66d9ef">with</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_::</span>boqFile<span style="color:#f92672">::</span>factorFFile<span style="color:#f92672">::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">@&#34;\boq.csv&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">@&#34;\FactorF.csv&#34;</span>
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;%s&#34;</span> boqFile
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;%s&#34;</span> factorFFile
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;Should not be here&#34;</span>
</span></span></code></pre></div><p>We use Csv Type Provider to read data from csv files and transform each csv row to designated type (BoQItem and FactorFTable).
The domain code could be referenced in the script by referring to the class library dll (CoCoTender.Domain.dll).
The transformation is straightforward, so I will skip that.</p>
<p>The interesting bit of code is the way that we can actually create console application by just using script file.
The <strong>fsi.CommandLineArgs</strong> will read argument from the command line. For simplicity, we will assume that the first argument will be the path to boq item file and the second one will be for factor f file. If user does not specify the path, we will just use the default one</p>
<p>We can test this script by running following command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet fsi scratch.fsx &lt;path to boq.csv&gt; &lt;path to factorf.csv&gt;
</span></span></code></pre></div><p>The result should be the same as unit test since we use the same test data.</p>
<p>Now we are ready to create actual console application.
Type following commands to create console project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd src
</span></span><span style="display:flex;"><span>dotnet new console -lang F# -o CoCoTender.Console
</span></span><span style="display:flex;"><span>cd CoCoTender.Console
</span></span><span style="display:flex;"><span>dotnet add reference ../CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FSharp.Data 
</span></span></code></pre></div><p>Then you just need to copy the code from fsx file to Program.fs.
Here is the final result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">open</span> System.IO
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FSharp.Data
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> BoQItem
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>Literal<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// let ResolutionFolder = @&#34;c:/projs/CoCoTender/src/scripts/&#34;// __SOURCE_DIRECTORY__ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> ResolutionFolder <span style="color:#f92672">=</span>  <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> BoQFile <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItems</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;boq.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> toBoQItem <span style="color:#f92672">(</span>row<span style="color:#f92672">:</span>BoQItems.Row<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>row<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> row<span style="color:#f92672">.</span>Unit<span style="color:#f92672">.</span>Trim()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Material
</span></span><span style="display:flex;"><span>                Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>                UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Labor
</span></span><span style="display:flex;"><span>            Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>            UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BoQItem.tryCreate row<span style="color:#f92672">.</span>Description qty material labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        BoQItems
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.choose toBoQItem 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> FactorFFile <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FactorFs</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;FactorF.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        FactorFs
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> FactorFTable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>EntryPoint<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> main args <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    printfn <span style="color:#e6db74">&#34;%A&#34;</span> args
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> args <span style="color:#f92672">|&gt;</span> List.ofArray <span style="color:#66d9ef">with</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> boqFile<span style="color:#f92672">::</span>factorFFile<span style="color:#f92672">::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>FactorFFile.load factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BoQFile.load boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> [] <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;boq.csv&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;factorf.csv&#34;</span>
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;%s&#34;</span> boqFile
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;%s&#34;</span> factorFFile
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>FactorFFile.load factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BoQFile.load boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;Should not be here&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    0
</span></span></code></pre></div><p>Let&rsquo;s try running the console:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet run boq.csv factorf.csv
</span></span></code></pre></div><p>I show the application to the domain expert and let their play with the program.</p>
<p><strong>Expert</strong>: Can I create boq item with invalid data? Such as having item with different unit?
<strong>Me</strong>: Sure, if you do that those line will be skipped.
<strong>Expert</strong>: Hmmm, I don&rsquo;t think that&rsquo;s right. User should immediately see the problem.</p>
<p>You might felt bad about not creating the right solution for the client in the first place. But don&rsquo;t worry, this way of showing immediate feed back to the client (aka. REPL on steroid) is so much better for both developer and the users of the system. Since, all the misunderstanding could be cleared out in days; not weeks, or even months.</p>
<p><strong>Me</strong>: We can fix that. Should I show the error for that line in particular?
<strong>Expert</strong>: We would like to see the whole error. It should show all the error for each line. So the user can fix all of them before re-estimate the data.</p>
<p>What we need to do is to keep error message for each items if any and show them. If there is no error, we just return the estimated code. This is where FsErrorToolkit comes to play.</p>
<h1 id="fserrortoolkit">FsErrorToolKit<a hidden class="anchor" aria-hidden="true" href="#fserrortoolkit">#</a></h1>
<p>I really like railway-oriented programming style. I think it&rsquo;s straightforward and can blend well with function programming style. Recently, F# has already include Result type into the core language. But I heard many good things from library FsErrorToolkit. So I will give it a shot for this project.</p>
<p>Before using the toolking in the Domain library, it&rsquo;s often a good idea to pivot any library with fsx script first.
Here is my plan of introducing new code to fsharp solution.</p>
<ol>
<li>Try out in fsx script</li>
<li>Change the actual code</li>
<li>Change unit testing</li>
</ol>
<p>Start by copying the code from Domain to fsx file and change the most outer function (estimateCost) to use Result type and gradually change from there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> estimateCost<span style="color:#66d9ef">&#39;</span> loadFactorFTable <span style="color:#f92672">=</span> calcDirectCost <span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">(</span>applyFactorF loadFactorFTable<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;&gt;</span> roundCost 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> estimateCost loadFactorFTable items <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost&#39; loadFactorFTable items
</span></span><span style="display:flex;"><span>    Ok cost
</span></span></code></pre></div><p>Since this function has no error, so we just return cost with Ok constructor.
How about the one that can cause error like creating boq item. Previously, if we could not create item, we just return None. But now we want to return Error with helpful message instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> areUnitsMatched  qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> materialUnitCost<span style="color:#f92672">,</span> laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(_,</span> qtyUnit<span style="color:#f92672">),</span> Material <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> materialUnit<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> laborUnit<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      qtyUnit <span style="color:#f92672">=</span> materialUnit <span style="color:#f92672">&amp;&amp;</span> qtyUnit <span style="color:#f92672">=</span> laborUnit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryRecalcTotalCost item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> calcTotalCost() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> item<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> item<span style="color:#f92672">.</span>MaterialUnitCost<span style="color:#f92672">,</span> item<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(</span>qty<span style="color:#f92672">,_),</span> Material <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> mUnitCost<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> lbUnitCost<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> mUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> lbUnitCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    result 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> areUnitsMatched item<span style="color:#f92672">.</span>Quantity item<span style="color:#f92672">.</span>MaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> Result.requireTrue <span style="color:#e6db74">&#34;Unit are Not matched.&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span> item <span style="color:#66d9ef">with</span> TotalCost <span style="color:#f92672">=</span> calcTotalCost() <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCreate desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span> result <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> areUnitsMatched qty materialUnitCost laborUnitCost <span style="color:#f92672">|&gt;</span> Result.requireTrue <span style="color:#e6db74">&#34;Unit are Not matched.&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let!</span> item <span style="color:#f92672">=</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        Description <span style="color:#f92672">=</span> desc
</span></span><span style="display:flex;"><span>        Quantity <span style="color:#f92672">=</span> qty
</span></span><span style="display:flex;"><span>        MaterialUnitCost <span style="color:#f92672">=</span> materialUnitCost
</span></span><span style="display:flex;"><span>        LaborUnitCost <span style="color:#f92672">=</span> laborUnitCost
</span></span><span style="display:flex;"><span>        TotalCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> tryRecalcTotalCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item      
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>This requires some explanations. Function try create is inside result computation expression which means that when any error occurs, execution will return from the function immediately. This way of coding significantly remove boiler plat code. The intention is much clearer but at the same time, it comes with cause of understanding what CE (computation expression) is. But I think it&rsquo;s worthwhile.</p>
<p>Here we go for tryCreate:</p>
<ol>
<li>Check if areUnitsMatched function which return boolean. If the validation function return false, return from CE immediately with error message &ldquo;Unit are Not matched&rdquo;.</li>
<li>Recalculate the total cost. See that we use let! when calling function returning result type (tryRecalcTotalCost in this case)</li>
</ol>
<p>After checking that the new script with result CE works as expected, just copy the code to Library.fs file.
Don&rsquo;t forget to add the toolkit to the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd src<span style="color:#ae81ff">\C</span>oCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FsErrorToolKit.ErrorHandling
</span></span></code></pre></div><p>We need to change the Test project to use Result type as well. Here is an example for creating boq item test:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should succeed if Quantity, Material and Labor use the same Unit`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.create desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Ok item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Description <span style="color:#f92672">|&gt;</span> should equal desc
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Quantity <span style="color:#f92672">|&gt;</span> should equal qty
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>MaterialUnitCost <span style="color:#f92672">|&gt;</span> should equal material
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> should equal labor
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Error msg <span style="color:#f92672">-&gt;</span> Assert.Fail msg
</span></span></code></pre></div><p>We just need to match the result with Ok and Error.
Finally, we are almost at the end of this post. The only thing left is to update the Console application to use Result type.
The only function that require understanding is the load function for BoQ item.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        BoQItems
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.map toBoQItem 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.sequenceResultA
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">function</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Ok items <span style="color:#f92672">-&gt;</span> items
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Error msgs <span style="color:#f92672">-&gt;</span> failwith <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;{msgs}&#34;</span>
</span></span></code></pre></div><p>Remember that the expert wants the error for each boq item (if any). After we map toBoQItem for each row, we will get sequence of Result type. But what we really want is just one Result with <strong>a list</strong> of Ok or Error instead. For example, if there are 2 error after load boq item. We want to have result as Error [ &ldquo;error msg1&rdquo;; &ldquo;error msg2&rdquo; ].
All of this can be accomplished by <strong>List.sequenceResultA</strong> provided by the toolkit.<br>
If there are any error, the program will fail and show list of error messages.</p>
<p>It&rsquo;s all done for this post now. You can get the code for this post by clone with tag v0.2.0.
Till next time!</p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
    <span>&copy; 2023 <a href="https://twuttiwat.github.io/">TW Blog</a></span>
    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
</body>

</html>
