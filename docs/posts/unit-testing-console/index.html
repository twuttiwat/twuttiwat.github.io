<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Unit Testing and Console Application :: TW Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.
This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.
So many things to do in this post, let&rsquo;s start&hellip;
Class Library Since we are going to create real application this time, we should create our solution before creating any project. I like to use command line so I follow script from Ian Russel as follow:
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/unit-testing-console/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Unit Testing and Console Application">
<meta property="og:description" content="Good day. Sorry, I am back after busy weeks. To bring back our past weeks, we did finish domain modeling in fsx file.
This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.
So many things to do in this post, let&rsquo;s start&hellip;
Class Library Since we are going to create real application this time, we should create our solution before creating any project. I like to use command line so I follow script from Ian Russel as follow:
" />
<meta property="og:url" content="http://localhost:1313/posts/unit-testing-console/" />
<meta property="og:site_name" content="TW Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2022-11-19 11:57:43 &#43;0700 &#43;07" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/unit-testing-console/">Unit Testing and Console Application</a>
  </h1>
  <div class="post-meta"><time class="post-date">2022-11-19</time><span class="post-author">Teerawat Wuttiwat</span></div>

  
  


  

  <div class="post-content"><div>
        <p>Good day. Sorry, I am back after busy weeks.
To bring back our past weeks, we did finish domain modeling in fsx file.</p>
<p>This week we will start touching the road. We create class library from our script file, do unit testing for our library, and finally let the client test our functionality with our console application.</p>
<p>So many things to do in this post, let&rsquo;s start&hellip;</p>
<h1 id="class-library">Class Library<a href="#class-library" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>Since we are going to create real application this time, we should create our solution before creating any project. I like to use command line so I follow script from Ian Russel as follow:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet new sln -o CoCoTender
</span></span><span style="display:flex;"><span>dotnet new gitignore
</span></span><span style="display:flex;"><span>cd CoCoTender
</span></span><span style="display:flex;"><span>mkdir src
</span></span><span style="display:flex;"><span>cd src
</span></span><span style="display:flex;"><span>dotnet new classlib -lang F# -o CoCoTender.Domain
</span></span><span style="display:flex;"><span>cd ..
</span></span><span style="display:flex;"><span>dotnet sln add src/CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet build
</span></span></code></pre></div><p>There should be no error after you run &lsquo;dotnet build&rsquo; command.
Also, I did create gitignore for entire solution by using nifty dotnet new command. That&rsquo;s awesome.</p>
<p>Like what we did in the past, we will do it one by one.</p>
<ol>
<li>Copy BoQItem module from scratch.fsx file to Library.fs.
Here is the code:</li>
</ol>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">namespace</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">Quantity</span> <span style="color:#f92672">=</span> Quantity <span style="color:#66d9ef">of</span> <span style="color:#66d9ef">float</span><span style="color:#f92672">*</span><span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">UnitCost</span> <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Name <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    UnitCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>    Unit <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">MaterialUnitCost</span> <span style="color:#f92672">=</span> Material <span style="color:#66d9ef">of</span> UnitCost
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LaborUnitCost</span> <span style="color:#f92672">=</span> Labor <span style="color:#66d9ef">of</span> UnitCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItem</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">private</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Description <span style="color:#f92672">:</span> <span style="color:#66d9ef">string</span>
</span></span><span style="display:flex;"><span>    Quantity <span style="color:#f92672">:</span> Quantity
</span></span><span style="display:flex;"><span>    MaterialUnitCost <span style="color:#f92672">:</span> MaterialUnitCost
</span></span><span style="display:flex;"><span>    LaborUnitCost <span style="color:#f92672">:</span> LaborUnitCost
</span></span><span style="display:flex;"><span>    TotalCost <span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> BoQItem <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> calcCost qty unitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> unitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(</span>qty<span style="color:#f92672">,</span> qtyUnit<span style="color:#f92672">),</span> <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> unitCost<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> unitCostUnit<span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">when</span> qtyUnit <span style="color:#f92672">=</span> unitCostUnit <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> unitCost<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> Some
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCalcItemCost qty <span style="color:#f92672">(</span>Material materialUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>Labor laborUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>  
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> calcCost qty materialUnitCost<span style="color:#f92672">,</span> calcCost qty laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Some materialCost<span style="color:#f92672">,</span> Some laborCost <span style="color:#f92672">-&gt;</span> Some <span style="color:#f92672">(</span>materialCost <span style="color:#f92672">+</span> laborCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> isValid desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> materialUnitCost<span style="color:#f92672">,</span> laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(_,</span> qtyUnit<span style="color:#f92672">),</span> Material <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> materialUnit<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> laborUnit<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      qtyUnit <span style="color:#f92672">=</span> materialUnit <span style="color:#f92672">&amp;&amp;</span> qtyUnit <span style="color:#f92672">=</span> laborUnit  
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCreate desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isValid desc qty materialUnitCost laborUnitCost  <span style="color:#66d9ef">then</span> 
</span></span><span style="display:flex;"><span>      tryCalcItemCost qty materialUnitCost laborUnitCost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> Option.map<span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>          Description <span style="color:#f92672">=</span> desc
</span></span><span style="display:flex;"><span>          Quantity <span style="color:#f92672">=</span> qty
</span></span><span style="display:flex;"><span>          MaterialUnitCost <span style="color:#f92672">=</span> materialUnitCost
</span></span><span style="display:flex;"><span>          LaborUnitCost <span style="color:#f92672">=</span> laborUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">else</span>
</span></span><span style="display:flex;"><span>      None
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> value item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{|</span> 
</span></span><span style="display:flex;"><span>      Description <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>Description
</span></span><span style="display:flex;"><span>      Quantity <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>Quantity
</span></span><span style="display:flex;"><span>      MaterialUnitCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>      LaborUnitCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>      TotalCost <span style="color:#f92672">=</span> item<span style="color:#f92672">.</span>TotalCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|}</span>
</span></span></code></pre></div><p>It&rsquo;s the exact same code as script file. Just add namespace CoCoTender.Domain at the top.</p>
<p>Next, we need to move our test code from our script file to unit testing project. Here is the command to create the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>mkdir tests
</span></span><span style="display:flex;"><span>cd tests
</span></span><span style="display:flex;"><span>dotnet new xunit -lang F# -o CoCoTender.DomainTests
</span></span><span style="display:flex;"><span>dotnet add reference ../../src/CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FsUnit
</span></span><span style="display:flex;"><span>dotnte add Package FsUnit.XUnit
</span></span><span style="display:flex;"><span>cd ..
</span></span><span style="display:flex;"><span>dotnet sln add tests/CoCoTender.DomainTests
</span></span><span style="display:flex;"><span>dotnet test
</span></span></code></pre></div><p>The result should show that all tests are passed.
Let&rsquo;s create our firs test.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> Tests
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> System
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Xunit
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FsUnit
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Create boq item`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Item&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Big Tile&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> totalCost <span style="color:#f92672">=</span> 10<span style="color:#f92672">*</span>100 <span style="color:#f92672">+</span> 10<span style="color:#f92672">*</span>50
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should succeed if Quantity, Material and Labor use the same Unit`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Description <span style="color:#f92672">|&gt;</span> should equal desc
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Quantity <span style="color:#f92672">|&gt;</span> should equal qty
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>MaterialUnitCost <span style="color:#f92672">|&gt;</span> should equal material
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> should equal labor
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not create BoQItem&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should fail if Quantity, Material and Labor have different Units`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> material <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>Material m<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>m <span style="color:#66d9ef">with</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> labor <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> <span style="color:#f92672">(</span>Labor l<span style="color:#f92672">)</span> <span style="color:#f92672">-&gt;</span> <span style="color:#f92672">{</span>l <span style="color:#66d9ef">with</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;cm&#34;</span><span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material&#39; labor&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.True<span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Should not create BoQItem with different Unit&#34;</span>        
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should always calculate total cost when create`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.tryCreate desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal totalCost
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> None <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not create BoQItem&#34;</span> 
</span></span></code></pre></div><p>There are 3 tests we want to verify when creating boq item.</p>
<ol>
<li>It should succeeded when all units are matched.</li>
<li>It should failed when some units are not matched.</li>
<li>It should always calculate total cost when create new item.</li>
</ol>
<p>Run</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet test
</span></span></code></pre></div><p>To see if all tests are passed.</p>
<p>We are done with item creation logic. Next, we will add updating boq function from the database.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> updateDesc newDesc item <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> item <span style="color:#66d9ef">with</span> Description <span style="color:#f92672">=</span> newDesc <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateQty newQty item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    tryCalcItemCost newQty item<span style="color:#f92672">.</span>MaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          Quantity <span style="color:#f92672">=</span> newQty
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateMaterialUnitCost <span style="color:#f92672">(</span>Material newUnitCost<span style="color:#f92672">)</span> item <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> newMaterialUnitCost <span style="color:#f92672">=</span> Material newUnitCost
</span></span><span style="display:flex;"><span>    tryCalcItemCost item<span style="color:#f92672">.</span>Quantity newMaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          MaterialUnitCost <span style="color:#f92672">=</span> newMaterialUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryUpdateLaborUnitCost <span style="color:#f92672">(</span>Labor newUnitCost<span style="color:#f92672">)</span> item <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> newLaborUnitCost <span style="color:#f92672">=</span> Labor newUnitCost
</span></span><span style="display:flex;"><span>    tryCalcItemCost item<span style="color:#f92672">.</span>Quantity item<span style="color:#f92672">.</span>MaterialUnitCost newLaborUnitCost 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Option.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> cost <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        item <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>          LaborUnitCost <span style="color:#f92672">=</span> newLaborUnitCost
</span></span><span style="display:flex;"><span>          TotalCost <span style="color:#f92672">=</span> cost
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">})</span>
</span></span></code></pre></div><p>Don&rsquo;t forget to build the library first before create another unit tests. But the ionide extension should show any error immediately without compilation though.</p>
<p>Here is the unit tests for the update functions:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Update boq item`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> desc <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Item&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Big Tile&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> BoQItem.tryCreate desc qty material labor <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> item&#39;
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;Could not create item for updating&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> totalCost <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>TotalCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``with quantity should always re-calculate total cost`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdateQty <span style="color:#f92672">(</span>Quantity <span style="color:#f92672">(</span>20<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal<span style="color:#66d9ef">&#39;</span> <span style="color:#f92672">=</span> item&#39; <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal&#39;<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal <span style="color:#f92672">(</span>totalCost <span style="color:#f92672">*</span> 2<span style="color:#f92672">.</span>0<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> Assert.Fail <span style="color:#e6db74">&#34;Could not update quantity&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``with description should not update total cost`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.updateDesc <span style="color:#e6db74">&#34;New Pool&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> resultVal <span style="color:#f92672">=</span> result <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>        resultVal<span style="color:#f92672">.</span>TotalCost <span style="color:#f92672">|&gt;</span> should equal totalCost
</span></span></code></pre></div><p>The explanation in function name should be suffice. What we want here is to make sure that whenever there are changes in boq item, recalculation should occur.</p>
<p>The last unit testing is for estimating total cost of the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">module</span> ``Estimate construction cost`` <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> loadFactorFTableFn <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">function</span> () <span style="color:#f92672">-&gt;</span> FactorFTable <span style="color:#f92672">[(</span>10<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>1<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>100<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>5<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>1000<span style="color:#f92672">,</span> 1<span style="color:#f92672">.</span>9<span style="color:#f92672">)]</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should return correct result`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> estimateCost loadFactorFTableFn <span style="color:#f92672">[</span>item<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|&gt;</span> should equal 2000
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should not round when less than one thousand`` () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> smallPool <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">match</span> item <span style="color:#f92672">|&gt;</span> BoQItem.tryUpdateQty <span style="color:#f92672">(</span>Quantity <span style="color:#f92672">(</span>1<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">))</span> <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Some item&#39; <span style="color:#f92672">-&gt;</span> item&#39;
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> failwith <span style="color:#e6db74">&#34;Could not update quantity&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> estimateCost loadFactorFTableFn <span style="color:#f92672">[</span>smallPool<span style="color:#f92672">]</span> 
</span></span><span style="display:flex;"><span>        result <span style="color:#f92672">|&gt;</span> should <span style="color:#f92672">(</span>equalWithin 0<span style="color:#f92672">.</span>11<span style="color:#f92672">)</span> 228<span style="color:#f92672">.</span>33
</span></span></code></pre></div><p>As you can see, all test functions are originated from our script file. We just organice into module and function to make the intention of the tests clearer.</p>
<h1 id="console">Console<a href="#console" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>I found that it&rsquo;s best to show tangible result to the users as soon as I can. Since, creating whole webapp might take too long at this stage. So I think it&rsquo;s best to start with just console application.</p>
<p>The goal of this console is to let client test the input. The input should be easy for client to create and at the same time should not take too long for us to code. I think Csv files are the optimal choice for this since it is very easy to create using just Excel or Google Sheet. Also there are f# type provider just for this.</p>
<p>The input files we are going to create for testing are for BoQ item and Factor F table.
Here is the format of these 2 files:</p>
<p>BoQ Items</p>
<table>
  <thead>
      <tr>
          <th>Description</th>
          <th>Quantity</th>
          <th>Unit</th>
          <th>Material</th>
          <th>MaterialUnit</th>
          <th>MaterialUnitCost</th>
          <th>Labor</th>
          <th>LaborUnit</th>
          <th>LaborUnitCost</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Pool Tile</td>
          <td>10</td>
          <td>m^2</td>
          <td>Big Tile</td>
          <td>m^2</td>
          <td>100</td>
          <td>Do Tiling</td>
          <td>m^2</td>
          <td>50</td>
      </tr>
  </tbody>
</table>
<p>Factor F Table</p>
<table>
  <thead>
      <tr>
          <th>DirectCost</th>
          <th>FactorF</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>10</td>
          <td>1.1</td>
      </tr>
      <tr>
          <td>100</td>
          <td>1.5</td>
      </tr>
      <tr>
          <td>1000</td>
          <td>1.9</td>
      </tr>
  </tbody>
</table>
<p>Again, we will start with fsx script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">&#34;nuget: FSharp.Data, 5.0.2&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">@&#34;C:\projs\CoCoTender\src\CoCoTender.Domain\bin\Debug\net6.0\CoCoTender.Domain.dll&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FSharp.Data
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> BoQItem
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>Literal<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> ResolutionFolder <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItems</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;boq.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> toBoQItem <span style="color:#f92672">(</span>row<span style="color:#f92672">:</span>BoQItems.Row<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>row<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> row<span style="color:#f92672">.</span>Unit<span style="color:#f92672">.</span>Trim()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Material
</span></span><span style="display:flex;"><span>        Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>        UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>      Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Labor
</span></span><span style="display:flex;"><span>      Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>      UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  BoQItem.tryCreate row<span style="color:#f92672">.</span>Description qty material labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> loadBoQFile <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>  BoQItems
</span></span><span style="display:flex;"><span>    .Load<span style="color:#f92672">(__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/boq.csv&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> Seq.choose toBoQItem 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FactorFFile</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;FactorF.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> loadFactorFFile <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>  FactorFFile
</span></span><span style="display:flex;"><span>    .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> List.ofSeq 
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">|&gt;</span> FactorFTable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/boq.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34;/FactorF.csv&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">match</span> fsi<span style="color:#f92672">.</span>CommandLineArgs <span style="color:#f92672">|&gt;</span> List.ofArray <span style="color:#66d9ef">with</span> 
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_::</span>boqFile<span style="color:#f92672">::</span>factorFFile<span style="color:#f92672">::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">@&#34;\boq.csv&#34;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span> <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ <span style="color:#f92672">+</span> <span style="color:#e6db74">@&#34;\FactorF.csv&#34;</span>
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;%s&#34;</span> boqFile
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;%s&#34;</span> factorFFile
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>loadFactorFFile factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>loadBoQFile boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>  printfn <span style="color:#e6db74">&#34;Should not be here&#34;</span>
</span></span></code></pre></div><p>We use Csv Type Provider to read data from csv files and transform each csv row to designated type (BoQItem and FactorFTable).
The domain code could be referenced in the script by referring to the class library dll (CoCoTender.Domain.dll).
The transformation is straightforward, so I will skip that.</p>
<p>The interesting bit of code is the way that we can actually create console application by just using script file.
The <strong>fsi.CommandLineArgs</strong> will read argument from the command line. For simplicity, we will assume that the first argument will be the path to boq item file and the second one will be for factor f file. If user does not specify the path, we will just use the default one</p>
<p>We can test this script by running following command</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet fsi scratch.fsx &lt;path to boq.csv&gt; &lt;path to factorf.csv&gt;
</span></span></code></pre></div><p>The result should be the same as unit test since we use the same test data.</p>
<p>Now we are ready to create actual console application.
Type following commands to create console project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd src
</span></span><span style="display:flex;"><span>dotnet new console -lang F# -o CoCoTender.Console
</span></span><span style="display:flex;"><span>cd CoCoTender.Console
</span></span><span style="display:flex;"><span>dotnet add reference ../CoCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FSharp.Data 
</span></span></code></pre></div><p>Then you just need to copy the code from fsx file to Program.fs.
Here is the final result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">open</span> System.IO
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> FSharp.Data
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> CoCoTender.Domain
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> BoQItem
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">open</span> Project
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>Literal<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// let ResolutionFolder = @&#34;c:/projs/CoCoTender/src/scripts/&#34;// __SOURCE_DIRECTORY__ 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span><span style="color:#66d9ef">let</span> ResolutionFolder <span style="color:#f92672">=</span>  <span style="color:#f92672">__</span>SOURCE_DIRECTORY__ 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> BoQFile <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">BoQItems</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;boq.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> toBoQItem <span style="color:#f92672">(</span>row<span style="color:#f92672">:</span>BoQItems.Row<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>row<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> row<span style="color:#f92672">.</span>Unit<span style="color:#f92672">.</span>Trim()<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>                Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Material
</span></span><span style="display:flex;"><span>                Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>                UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>MaterialUnitCost
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|&gt;</span> Material
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>            Name <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>Labor
</span></span><span style="display:flex;"><span>            Unit <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnit<span style="color:#f92672">.</span>Trim()
</span></span><span style="display:flex;"><span>            UnitCost <span style="color:#f92672">=</span> row<span style="color:#f92672">.</span>LaborUnitCost
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|&gt;</span> Labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        BoQItem.tryCreate row<span style="color:#f92672">.</span>Description qty material labor
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        BoQItems
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.choose toBoQItem 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">module</span> FactorFFile <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">type</span> <span style="color:#a6e22e">FactorFs</span> <span style="color:#f92672">=</span> CsvProvider<span style="color:#f92672">&lt;</span><span style="color:#e6db74">&#34;FactorF.csv&#34;</span><span style="color:#f92672">,</span> ResolutionFolder<span style="color:#f92672">=</span>ResolutionFolder<span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        FactorFs
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> FactorFTable
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>EntryPoint<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> main args <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    printfn <span style="color:#e6db74">&#34;%A&#34;</span> args
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> args <span style="color:#f92672">|&gt;</span> List.ofArray <span style="color:#66d9ef">with</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> boqFile<span style="color:#f92672">::</span>factorFFile<span style="color:#f92672">::_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>FactorFFile.load factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BoQFile.load boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> [] <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> boqFile <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;boq.csv&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> factorFFile <span style="color:#f92672">=</span>  <span style="color:#e6db74">&#34;factorf.csv&#34;</span>
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;%s&#34;</span> boqFile
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;%s&#34;</span> factorFFile
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost <span style="color:#f92672">(</span>FactorFFile.load factorFFile<span style="color:#f92672">)</span> <span style="color:#f92672">(</span>BoQFile.load boqFile<span style="color:#f92672">)</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Estimate Cost is {cost}&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>        printfn <span style="color:#e6db74">&#34;Should not be here&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    0
</span></span></code></pre></div><p>Let&rsquo;s try running the console:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>dotnet run boq.csv factorf.csv
</span></span></code></pre></div><p>I show the application to the domain expert and let their play with the program.</p>
<p><strong>Expert</strong>: Can I create boq item with invalid data? Such as having item with different unit?
<strong>Me</strong>: Sure, if you do that those line will be skipped.
<strong>Expert</strong>: Hmmm, I don&rsquo;t think that&rsquo;s right. User should immediately see the problem.</p>
<p>You might felt bad about not creating the right solution for the client in the first place. But don&rsquo;t worry, this way of showing immediate feed back to the client (aka. REPL on steroid) is so much better for both developer and the users of the system. Since, all the misunderstanding could be cleared out in days; not weeks, or even months.</p>
<p><strong>Me</strong>: We can fix that. Should I show the error for that line in particular?
<strong>Expert</strong>: We would like to see the whole error. It should show all the error for each line. So the user can fix all of them before re-estimate the data.</p>
<p>What we need to do is to keep error message for each items if any and show them. If there is no error, we just return the estimated code. This is where FsErrorToolkit comes to play.</p>
<h1 id="fserrortoolkit">FsErrorToolKit<a href="#fserrortoolkit" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>I really like railway-oriented programming style. I think it&rsquo;s straightforward and can blend well with function programming style. Recently, F# has already include Result type into the core language. But I heard many good things from library FsErrorToolkit. So I will give it a shot for this project.</p>
<p>Before using the toolking in the Domain library, it&rsquo;s often a good idea to pivot any library with fsx script first.
Here is my plan of introducing new code to fsharp solution.</p>
<ol>
<li>Try out in fsx script</li>
<li>Change the actual code</li>
<li>Change unit testing</li>
</ol>
<p>Start by copying the code from Domain to fsx file and change the most outer function (estimateCost) to use Result type and gradually change from there.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> estimateCost<span style="color:#66d9ef">&#39;</span> loadFactorFTable <span style="color:#f92672">=</span> calcDirectCost <span style="color:#f92672">&gt;&gt;</span> <span style="color:#f92672">(</span>applyFactorF loadFactorFTable<span style="color:#f92672">)</span> <span style="color:#f92672">&gt;&gt;</span> roundCost 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> estimateCost loadFactorFTable items <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> cost <span style="color:#f92672">=</span> estimateCost&#39; loadFactorFTable items
</span></span><span style="display:flex;"><span>    Ok cost
</span></span></code></pre></div><p>Since this function has no error, so we just return cost with Ok constructor.
How about the one that can cause error like creating boq item. Previously, if we could not create item, we just return None. But now we want to return Error with helpful message instead.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> areUnitsMatched  qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">match</span> qty<span style="color:#f92672">,</span> materialUnitCost<span style="color:#f92672">,</span> laborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(_,</span> qtyUnit<span style="color:#f92672">),</span> Material <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> materialUnit<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>Unit <span style="color:#f92672">=</span> laborUnit<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>      qtyUnit <span style="color:#f92672">=</span> materialUnit <span style="color:#f92672">&amp;&amp;</span> qtyUnit <span style="color:#f92672">=</span> laborUnit
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryRecalcTotalCost item <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> calcTotalCost() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">match</span> item<span style="color:#f92672">.</span>Quantity<span style="color:#f92672">,</span> item<span style="color:#f92672">.</span>MaterialUnitCost<span style="color:#f92672">,</span> item<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|</span> Quantity <span style="color:#f92672">(</span>qty<span style="color:#f92672">,_),</span> Material <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> mUnitCost<span style="color:#f92672">},</span> Labor <span style="color:#f92672">{</span>UnitCost <span style="color:#f92672">=</span> lbUnitCost<span style="color:#f92672">}</span> <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> mUnitCost<span style="color:#f92672">)</span> <span style="color:#f92672">+</span> <span style="color:#f92672">(</span>qty <span style="color:#f92672">*</span> lbUnitCost<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>      
</span></span><span style="display:flex;"><span>    result 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> areUnitsMatched item<span style="color:#f92672">.</span>Quantity item<span style="color:#f92672">.</span>MaterialUnitCost item<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> Result.requireTrue <span style="color:#e6db74">&#34;Unit are Not matched.&#34;</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">{</span> item <span style="color:#66d9ef">with</span> TotalCost <span style="color:#f92672">=</span> calcTotalCost() <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">let</span> tryCreate desc qty materialUnitCost laborUnitCost <span style="color:#f92672">=</span> result <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span><span style="color:#f92672">!</span> areUnitsMatched qty materialUnitCost laborUnitCost <span style="color:#f92672">|&gt;</span> Result.requireTrue <span style="color:#e6db74">&#34;Unit are Not matched.&#34;</span> 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let!</span> item <span style="color:#f92672">=</span>  
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>        
</span></span><span style="display:flex;"><span>        Description <span style="color:#f92672">=</span> desc
</span></span><span style="display:flex;"><span>        Quantity <span style="color:#f92672">=</span> qty
</span></span><span style="display:flex;"><span>        MaterialUnitCost <span style="color:#f92672">=</span> materialUnitCost
</span></span><span style="display:flex;"><span>        LaborUnitCost <span style="color:#f92672">=</span> laborUnitCost
</span></span><span style="display:flex;"><span>        TotalCost <span style="color:#f92672">=</span> 0<span style="color:#f92672">.</span>0
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">}</span> 
</span></span><span style="display:flex;"><span>      <span style="color:#f92672">|&gt;</span> tryRecalcTotalCost
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> item      
</span></span><span style="display:flex;"><span>  <span style="color:#f92672">}</span>
</span></span></code></pre></div><p>This requires some explanations. Function try create is inside result computation expression which means that when any error occurs, execution will return from the function immediately. This way of coding significantly remove boiler plat code. The intention is much clearer but at the same time, it comes with cause of understanding what CE (computation expression) is. But I think it&rsquo;s worthwhile.</p>
<p>Here we go for tryCreate:</p>
<ol>
<li>Check if areUnitsMatched function which return boolean. If the validation function return false, return from CE immediately with error message &ldquo;Unit are Not matched&rdquo;.</li>
<li>Recalculate the total cost. See that we use let! when calling function returning result type (tryRecalcTotalCost in this case)</li>
</ol>
<p>After checking that the new script with result CE works as expected, just copy the code to Library.fs file.
Don&rsquo;t forget to add the toolkit to the project.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>cd src<span style="color:#ae81ff">\C</span>oCoTender.Domain
</span></span><span style="display:flex;"><span>dotnet add package FsErrorToolKit.ErrorHandling
</span></span></code></pre></div><p>We need to change the Test project to use Result type as well. Here is an example for creating boq item test:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">[&lt;</span>Fact<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> ``should succeed if Quantity, Material and Labor use the same Unit`` () <span style="color:#f92672">=</span> 
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> result <span style="color:#f92672">=</span> BoQItem.create desc qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> result <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Ok item <span style="color:#f92672">-&gt;</span> 
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> itemVal <span style="color:#f92672">=</span> item <span style="color:#f92672">|&gt;</span> BoQItem.value
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Description <span style="color:#f92672">|&gt;</span> should equal desc
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>Quantity <span style="color:#f92672">|&gt;</span> should equal qty
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>MaterialUnitCost <span style="color:#f92672">|&gt;</span> should equal material
</span></span><span style="display:flex;"><span>            itemVal<span style="color:#f92672">.</span>LaborUnitCost <span style="color:#f92672">|&gt;</span> should equal labor
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Error msg <span style="color:#f92672">-&gt;</span> Assert.Fail msg
</span></span></code></pre></div><p>We just need to match the result with Ok and Error.
Finally, we are almost at the end of this post. The only thing left is to update the Console application to use Result type.
The only function that require understanding is the load function for BoQ item.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> load <span style="color:#f92672">(</span>filePath<span style="color:#f92672">:</span><span style="color:#66d9ef">string</span><span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        BoQItems
</span></span><span style="display:flex;"><span>            .Load<span style="color:#f92672">(</span>filePath<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">.</span>Rows
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> Seq.map toBoQItem 
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> List.sequenceResultA
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">function</span>
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Ok items <span style="color:#f92672">-&gt;</span> items
</span></span><span style="display:flex;"><span>            <span style="color:#f92672">|</span> Error msgs <span style="color:#f92672">-&gt;</span> failwith <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;{msgs}&#34;</span>
</span></span></code></pre></div><p>Remember that the expert wants the error for each boq item (if any). After we map toBoQItem for each row, we will get sequence of Result type. But what we really want is just one Result with <strong>a list</strong> of Ok or Error instead. For example, if there are 2 error after load boq item. We want to have result as Error [ &ldquo;error msg1&rdquo;; &ldquo;error msg2&rdquo; ].
All of this can be accomplished by <strong>List.sequenceResultA</strong> provided by the toolkit.<br>
If there are any error, the program will fail and show list of error messages.</p>
<p>It&rsquo;s all done for this post now. You can get the code for this post by clone with tag v0.2.0.
Till next time!</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span> 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
