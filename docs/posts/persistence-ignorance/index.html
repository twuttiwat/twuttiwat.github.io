<!DOCTYPE html>
<html lang="en">
<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
  
    <title>Persistence (Almost) Ignorance :: TW Blog</title>
  
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" Old School Persistance Style Welcome back to my building webapp with f# series. Last week, I was kinda exausted from writing and capturing the screenshot for the safe stack post. So this week, we will do something simple. We will not add any new functionality. We will do following things.
Extract Persistence Layer Implement new NoSQL storage Create Storage class library Why Persistance Ignorance? If you know about Domain Driven Design already, you could skip this section. But if you don&rsquo;t, please keep along. The concept of this is that the persistence storage should not interwind with the Core Domain logic. You should be able to switch and change persistence technology as you see fit in which you&rsquo;ll see in this post.
" />
<meta name="keywords" content="" />

  <meta name="robots" content="noodp" />

<link rel="canonical" href="http://localhost:1313/posts/persistence-ignorance/" />





  
  <link rel="stylesheet" href="http://localhost:1313/css/buttons.min.86f6b4c106b6c6eb690ae5203d36b442c1f66f718ff4e8164fa86cf6c61ad641.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/code.min.d529ea4b2fb8d34328d7d31afc5466d5f7bc2f0bc9abdd98b69385335d7baee4.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/fonts.min.5bb7ed13e1d00d8ff39ea84af26737007eb5051b157b86fc24487c94f3dc8bbe.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/footer.min.eb8dfc2c6a7eafa36cd3ba92d63e69e849e2200e0002a228d137f236b09ecd75.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/gist.min.a751e8b0abe1ba8bc53ced52a38b19d8950fe78ca29454ea8c2595cf26aad5c0.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/header.min.75c7eb0e2872d95ff48109c6647d0223a38db52e2561dd87966eb5fc7c6bdac6.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/main.min.775ac2af004d44c22a6d000fbd1d9af529642f5cef27399d0280d180af2c2e9b.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/menu.min.310d32205bdedd6f43144e3c3273c9deecd238eba5f9108db5ea96ca0cfbe377.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/pagination.min.bbb986dbce00a5ce5aca0504b7925fc1c581992a4bf57f163e5d69cc1db7d836.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/post.min.ad50c7f4d00e7975918f37fc74c6029e1959a40d66fb5b2c6564a8715e985573.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/syntax.min.e9ab635cf918bc84b901eb65c0b2caa74c9544245e3647c1af5c129896ef276e.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terminal.min.e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855.css">

  
  <link rel="stylesheet" href="http://localhost:1313/css/terms.min.b81791663c3790e738e571cdbf802312390d30e4b1d8dc9d814a5b5454d0ac11.css">







<link rel="shortcut icon" href="http://localhost:1313/favicon.png">
<link rel="apple-touch-icon" href="http://localhost:1313/apple-touch-icon.png">


<meta name="twitter:card" content="summary" />



<meta property="og:locale" content="en" />
<meta property="og:type" content="article" />
<meta property="og:title" content="Persistence (Almost) Ignorance">
<meta property="og:description" content=" Old School Persistance Style Welcome back to my building webapp with f# series. Last week, I was kinda exausted from writing and capturing the screenshot for the safe stack post. So this week, we will do something simple. We will not add any new functionality. We will do following things.
Extract Persistence Layer Implement new NoSQL storage Create Storage class library Why Persistance Ignorance? If you know about Domain Driven Design already, you could skip this section. But if you don&rsquo;t, please keep along. The concept of this is that the persistence storage should not interwind with the Core Domain logic. You should be able to switch and change persistence technology as you see fit in which you&rsquo;ll see in this post.
" />
<meta property="og:url" content="http://localhost:1313/posts/persistence-ignorance/" />
<meta property="og:site_name" content="TW Blog" />

  <meta property="og:image" content="http://localhost:1313/og-image.png">

<meta property="og:image:width" content="1200">
<meta property="og:image:height" content="627">


  <meta property="article:published_time" content="2022-12-11 22:40:29 &#43;0700 &#43;07" />












</head>
<body>


<div class="container">

  <header class="header">
  <div class="header__inner">
    <div class="header__logo">
      <a href="http://localhost:1313/">
  <div class="logo">
    Terminal
  </div>
</a>

    </div>
    
    
  </div>
  
</header>


  <div class="content">
    
<article class="post">
  <h1 class="post-title">
    <a href="http://localhost:1313/posts/persistence-ignorance/">Persistence (Almost) Ignorance</a>
  </h1>
  <div class="post-meta"><time class="post-date">2022-12-11</time><span class="post-author">Teerawat Wuttiwat</span></div>

  
  


  

  <div class="post-content"><div>
        <figure><img src="/posts/persistence-ignorance/images/floppy-disks.png"
    alt="Floppy Disks Image" width="600"><figcaption>
      <h4>Old School Persistance Style</h4>
    </figcaption>
</figure>

<p>Welcome back to my <a href="../intro-fs-webapp-series/">building webapp with f# series</a>.
Last week, I was kinda exausted from writing and capturing the screenshot for the safe stack post.
So this week, we will do something simple. We will not add any new functionality. We will do following things.</p>
<ol>
<li>Extract Persistence Layer</li>
<li>Implement new NoSQL storage</li>
<li>Create Storage class library</li>
</ol>
<h1 id="why-persistance-ignorance">Why Persistance Ignorance?<a href="#why-persistance-ignorance" class="hanchor" ariaLabel="Anchor">#</a> </h1>
<p>If you know about Domain Driven Design already, you could skip this section. But if you don&rsquo;t, please keep along.
The concept of this is that the persistence storage should not interwind with the Core Domain logic.
You should be able to switch and change persistence technology as you see fit in which you&rsquo;ll see in this post.</p>
<p>You will also found that sometimes there are no golden rule to achive all the thing. So sometimes, change of core domain logic is needed. But we&rsquo;ll try our best to change as little as possible.</p>
<h2 id="extract-persistence-api">Extract Persistence Api<a href="#extract-persistence-api" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>If you look at the existing code, you will find that we are using the Storage module for load and restore BoQ items. You will find that the Api function sometimes read data directly from the Storage resize array. This will be a problem for coupling, the Api layer should not know how the implementation is done.</p>
<p>We should give the api layer, the Interface and let the functions cal that storage Interface.
Let&rsquo;s start by creating IStorageApi</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">IStorageApi</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">member</span> getBoQItems <span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> Result<span style="color:#f92672">&lt;</span>BoQItem <span style="color:#66d9ef">list</span><span style="color:#f92672">,</span><span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">member</span> addBoQItem <span style="color:#f92672">:</span> boqItem<span style="color:#f92672">:</span>BoQItem <span style="color:#f92672">-&gt;</span> Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unit</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">member</span> updateBoQItem <span style="color:#f92672">:</span> boqItem<span style="color:#f92672">:</span>BoQItem <span style="color:#f92672">-&gt;</span> Result<span style="color:#f92672">&lt;</span><span style="color:#66d9ef">unit</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">member</span> deleteBoQItem <span style="color:#f92672">:</span> itemId<span style="color:#f92672">:</span>Guid <span style="color:#f92672">-&gt;</span> Result<span style="color:#f92672">&lt;</span>Unit<span style="color:#f92672">,</span> <span style="color:#66d9ef">string</span><span style="color:#f92672">&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">abstract</span> <span style="color:#66d9ef">member</span> loadFactorFTable <span style="color:#f92672">:</span> <span style="color:#66d9ef">unit</span> <span style="color:#f92672">-&gt;</span> FactorFTable
</span></span></code></pre></div><p>Next, we will create new Class ResizeArray which will implement this interface</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">ResizeArrayStorage</span>() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> boqItems <span style="color:#f92672">=</span> ResizeArray<span style="color:#f92672">&lt;</span>BoQItem<span style="color:#f92672">&gt;</span>()
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> qty <span style="color:#f92672">=</span> Quantity <span style="color:#f92672">(</span>10<span style="color:#f92672">.</span>0<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> material <span style="color:#f92672">=</span> Material <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Pool Tile&#34;</span><span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0 <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> labor <span style="color:#f92672">=</span> Labor <span style="color:#f92672">{</span> Name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Do Tiling&#34;</span><span style="color:#f92672">;</span> Unit <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;m^2&#34;</span><span style="color:#f92672">;</span> UnitCost <span style="color:#f92672">=</span> 50<span style="color:#f92672">.</span>0 <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> defaultItem <span style="color:#f92672">=</span> BoQItem.tryCreate <span style="color:#f92672">(</span>Guid.NewGuid()<span style="color:#f92672">)</span> <span style="color:#e6db74">&#34;Pool Tile&#34;</span> qty material labor
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">match</span> defaultItem <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> Ok defaultItem&#39; <span style="color:#f92672">-&gt;</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">.</span>Add defaultItem&#39; <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>        <span style="color:#f92672">|</span> <span style="color:#f92672">_</span> <span style="color:#f92672">-&gt;</span> ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">interface</span> IStorageApi <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">getBoQItems</span>() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            boqItems <span style="color:#f92672">|&gt;</span> List.ofSeq <span style="color:#f92672">|&gt;</span> Ok
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">addBoQItem</span><span style="color:#f92672">(</span>boqItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">.</span>Add boqItem
</span></span><span style="display:flex;"><span>            Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">updateBoQItem</span><span style="color:#f92672">(</span>boqItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> boqItems<span style="color:#f92672">.</span>FindIndex<span style="color:#f92672">(</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#f92672">=</span> boqItem<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">[</span>index<span style="color:#f92672">]</span> <span style="color:#f92672">&lt;-</span> boqItem
</span></span><span style="display:flex;"><span>            Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">deleteBoQItem</span><span style="color:#f92672">(</span>itemId<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">let</span> index <span style="color:#f92672">=</span> boqItems<span style="color:#f92672">.</span>FindIndex<span style="color:#f92672">(</span> <span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x <span style="color:#f92672">|&gt;</span> BoQItem.value <span style="color:#f92672">|&gt;</span> <span style="color:#66d9ef">fun</span> y <span style="color:#f92672">-&gt;</span> y<span style="color:#f92672">.</span>Id <span style="color:#f92672">=</span> itemId<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">.</span>RemoveAt<span style="color:#f92672">(</span>index<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>            Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">loadFactorFTable</span>() <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            FactorFTable <span style="color:#f92672">[(</span>10<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>1<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>100<span style="color:#f92672">,</span>1<span style="color:#f92672">.</span>5<span style="color:#f92672">);</span> <span style="color:#f92672">(</span>1000<span style="color:#f92672">,</span> 1<span style="color:#f92672">.</span>9<span style="color:#f92672">)]</span>
</span></span></code></pre></div><p>I decide to go with class and interface instead of using record of function like ICoCoTenderApi. Since it&rsquo;s likely there will be intialization for each storage type. Having that done in the class constructor should simplify the caller code.</p>
<p>Now, we have our ResizeStorage ready. Let&rsquo;s use it in our cocoTenderApi definition.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> cocoTenderApi <span style="color:#f92672">(</span>storage<span style="color:#f92672">:</span>IStorageApi<span style="color:#f92672">)</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">...</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>We just supply the storage api to the application api. The cocoTenderApi implementation will not know what is underlying storage. It will just use the given storage api.</p>
<p>Replace all the storage related function to use this new api such as.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let!</span> boqItems <span style="color:#f92672">=</span> storage<span style="color:#f92672">.</span>getBoQItems()
</span></span></code></pre></div><p>Now we need to create the actual storage class and send to the api implementation.
Go to webApp definition</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> webApp <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>    Remoting.createApi ()
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.withRouteBuilder Route.builder
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.fromValue <span style="color:#f92672">(</span>cocoTenderApi <span style="color:#f92672">(</span>ResizeArrayStorage()<span style="color:#f92672">))</span>
</span></span><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.buildHttpHandler
</span></span></code></pre></div><p>Check the result. The web application should run as usual.</p>
<h2 id="implement-new-nosql-storage">Implement new NoSQL storage<a href="#implement-new-nosql-storage" class="hanchor" ariaLabel="Anchor">#</a> </h2>
<p>Initially, I plan to use SQL database but the safe stack documentation suggests <strong>LiteSharpDB</strong> as a simpler solution.
When I think about it, the CoCoTender application does not need integrity that much. Since all we need is just saving list of BoQ items ins and outs of the storage. So No SQL database is suffice for our application at the moment. And it&rsquo;s my first time using no sql database as well so I think it should be fun.</p>
<p>When working with new library, I like to play with it in script file first.
We will try to implement all StorageApi operation in script file then move it to actual project when it works.</p>
<p>Go to scripts/scratch.fsx.</p>
<p>Start by importing the library we need.
See that we also reference to our CoCoTender.Domain library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">&#34;nuget:LiteDB.FSharp&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">&#34;nuget:FsToolkit.ErrorHandling&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#r</span> <span style="color:#e6db74">@&#34;C:\projs\CoCoTender\src\CoCoTender.Domain\bin\Debug\net6.0\CoCoTender.Domain.dll&#34;</span>
</span></span></code></pre></div><p>Next, create database file in the script folder.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> database <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> mapper <span style="color:#f92672">=</span> FSharpBsonMapper()
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">let</span> connStr <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Filename={__SOURCE_DIRECTORY__}</span><span style="color:#ae81ff">\\</span><span style="color:#e6db74">CoCoTender.db;mode=Exclusive&#34;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#66d9ef">new</span> LiteDatabase <span style="color:#f92672">(</span>connStr<span style="color:#f92672">,</span> mapper<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>Then, implement all database operations. Coming from the SQL database, I found that the No SQL one is more like a magic. I mean if you follow all persistent requirement then suddenly all serialization id done for you. No need for schema. This maybe a good or bad thing though; depends on the application a hand.</p>
<p>Here is the implementation. First, we will list all the boq items.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> boqitems <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span>GetCollection<span style="color:#f92672">&lt;</span>BoQItem<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;boqitems&#34;</span>
</span></span><span style="display:flex;"><span>boqItems<span style="color:#f92672">.</span>FindAll () <span style="color:#f92672">|&gt;</span> List.ofSeq
</span></span></code></pre></div><p>Next is the insert operation.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>boqitems<span style="color:#f92672">.</span>Insert boqItem
</span></span></code></pre></div><p>This is super easy but ,like I said before, everything comes with a prices. First the Record type must have Id or id properties with value either int or Guid. Luckily, we already have that Id in our BoQItem. so this is not a problem.</p>
<p>But there is one requirement that we cannot ignore(pun intended). The record could not be <strong>private</strong> or else LiteDB will not be able to serialize the type.</p>
<p>This is bad since we are breaking the domain. I don&rsquo;t like this but at the cost of doing serialization code by myself. I think I am going to ignore that and go with the requirement.</p>
<p>Here is the change from</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">private</span> BoQItem <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span></code></pre></div><p>to</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#f92672">[&lt;</span>CLIMutable<span style="color:#f92672">&gt;]</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">private</span> BoQItem <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span></code></pre></div><p>Adding CLIMutable is also required for the LiteDB as well.
Too much mumble, let&rsquo;s do with update and delete</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> id <span style="color:#f92672">=</span> BsonValue<span style="color:#f92672">(</span>Guid<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">))</span> 
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> boqItem <span style="color:#f92672">=</span> boqitems<span style="color:#f92672">.</span>FindById<span style="color:#f92672">(</span>id<span style="color:#f92672">)</span> <span style="color:#75715e">// Find item by id
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> boqItem <span style="color:#f92672">=</span> <span style="color:#f92672">{</span> boqItem <span style="color:#66d9ef">with</span> Description <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;Foo&#34;</span> <span style="color:#f92672">}</span>
</span></span><span style="display:flex;"><span>boqitems<span style="color:#f92672">.</span>Update<span style="color:#f92672">(</span>boqItem<span style="color:#f92672">)</span> <span style="color:#75715e">// Update 
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span>boqitems<span style="color:#f92672">.</span>Delete<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;...&#34;</span><span style="color:#f92672">)</span> <span style="color:#75715e">// Delete
</span></span></span></code></pre></div><p>We also has issue with FactorF type since the type is just tuple of float which is not directly support by LiteDB. We fix the issue by creating intermediate type for FactorF called FactorFRec</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span>  <span style="color:#a6e22e">FactorFRec</span> <span style="color:#f92672">=</span> <span style="color:#f92672">{</span>
</span></span><span style="display:flex;"><span>    Id<span style="color:#f92672">:</span> int
</span></span><span style="display:flex;"><span>    DirectCost<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span>    FactorF<span style="color:#f92672">:</span> <span style="color:#66d9ef">float</span>
</span></span><span style="display:flex;"><span><span style="color:#f92672">}</span>
</span></span></code></pre></div><p>And changes the load factor f to map from FactorFRect to tuple</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> factorFs <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span>GetCollection<span style="color:#f92672">&lt;</span>FactorFRec<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;boqitems&#34;</span>
</span></span><span style="display:flex;"><span>factorFs<span style="color:#f92672">.</span>Insert <span style="color:#f92672">{</span> Id <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span> DirectCost <span style="color:#f92672">=</span> 10<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 1<span style="color:#f92672">.</span>1 <span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>factorFs<span style="color:#f92672">.</span>FindAll() <span style="color:#f92672">|&gt;</span> List.ofSeq <span style="color:#f92672">|&gt;</span> List.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span>
</span></span></code></pre></div><p>I am happy with how to work with the library. Now, I will move the code to Server code now. It&rsquo;s quite simple. We just need to implement function for IStorageApi with the code we try in the script.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span><span style="color:#66d9ef">type</span> <span style="color:#a6e22e">LiteDBStorage</span> () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> database <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> mapper <span style="color:#f92672">=</span> FSharpBsonMapper()
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">let</span> connStr <span style="color:#f92672">=</span> <span style="color:#f92672">$</span><span style="color:#e6db74">&#34;Filename=CoCoTender.db;mode=Exclusive&#34;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">new</span> LiteDatabase <span style="color:#f92672">(</span>connStr<span style="color:#f92672">,</span> mapper<span style="color:#f92672">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> boqItems <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span>GetCollection<span style="color:#f92672">&lt;</span>BoQItem<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;boqItems&#34;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">let</span> factorFs <span style="color:#f92672">=</span> database<span style="color:#f92672">.</span>GetCollection<span style="color:#f92672">&lt;</span>FactorFRec<span style="color:#f92672">&gt;</span> <span style="color:#e6db74">&#34;factorFs&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">do</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> factorFs<span style="color:#f92672">.</span>Count() <span style="color:#f92672">=</span> 0 <span style="color:#66d9ef">then</span>
</span></span><span style="display:flex;"><span>            factorFs<span style="color:#f92672">.</span>Insert <span style="color:#f92672">{</span> Id <span style="color:#f92672">=</span> 1<span style="color:#f92672">;</span> DirectCost <span style="color:#f92672">=</span> 10<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 1<span style="color:#f92672">.</span>1 <span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>            factorFs<span style="color:#f92672">.</span>Insert <span style="color:#f92672">{</span> Id <span style="color:#f92672">=</span> 2<span style="color:#f92672">;</span> DirectCost <span style="color:#f92672">=</span> 100<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 1<span style="color:#f92672">.</span>5 <span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>            factorFs<span style="color:#f92672">.</span>Insert <span style="color:#f92672">{</span> Id <span style="color:#f92672">=</span> 3<span style="color:#f92672">;</span> DirectCost <span style="color:#f92672">=</span> 1000<span style="color:#f92672">.</span>0<span style="color:#f92672">;</span> FactorF <span style="color:#f92672">=</span> 1<span style="color:#f92672">.</span>9 <span style="color:#f92672">}</span> <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">interface</span> IStorageApi <span style="color:#66d9ef">with</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">getBoQItems</span> () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">.</span>FindAll() <span style="color:#f92672">|&gt;</span> List.ofSeq <span style="color:#f92672">|&gt;</span> Ok
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">addBoQItem</span><span style="color:#f92672">(</span>boqItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            boqItems<span style="color:#f92672">.</span>Insert boqItem <span style="color:#f92672">|&gt;</span> ignore
</span></span><span style="display:flex;"><span>            Ok ()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">updateBoQItem</span><span style="color:#f92672">(</span>boqItem<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> boqItems<span style="color:#f92672">.</span>Update boqItem <span style="color:#66d9ef">then</span> Ok ()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> Error <span style="color:#e6db74">&#34;LiteDbStorage:Could not update boq item&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">deleteBoQItem</span><span style="color:#f92672">(</span>itemId<span style="color:#f92672">)</span> <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> boqItems<span style="color:#f92672">.</span>Delete itemId <span style="color:#66d9ef">then</span> Ok ()
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">else</span> Error <span style="color:#e6db74">&#34;LiteDbStorage:Could not delete boq item&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">member</span> _.<span style="color:#a6e22e">loadFactorFTable</span> () <span style="color:#f92672">=</span>
</span></span><span style="display:flex;"><span>            factorFs<span style="color:#f92672">.</span>FindAll() <span style="color:#f92672">|&gt;</span> List.ofSeq <span style="color:#f92672">|&gt;</span> List.map <span style="color:#f92672">(</span><span style="color:#66d9ef">fun</span> x <span style="color:#f92672">-&gt;</span> x<span style="color:#f92672">.</span>DirectCost<span style="color:#f92672">,</span>x<span style="color:#f92672">.</span>FactorF<span style="color:#f92672">)</span> <span style="color:#f92672">|&gt;</span> FactorFTable
</span></span></code></pre></div><p>Also, change the webApp initialization to use LiteDBStorage class.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>    <span style="color:#f92672">|&gt;</span> Remoting.fromValue <span style="color:#f92672">(</span>cocoTenderApi <span style="color:#f92672">(</span>LiteDBStorage()<span style="color:#f92672">))</span>
</span></span></code></pre></div><p>Now, checking the running application. Everything should work as expected.</p>
<p>We are at the last step now. When I see a lot of storage api scattered around in the Server code, I feel unconfortable. I think this code should belong into other place. The Api layer should be just orchestration between different component.</p>
<p>Let&rsquo;s extract the storage code to dedicated class library.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>cd src
</span></span><span style="display:flex;"><span>dotnet <span style="color:#66d9ef">new</span> classlib <span style="color:#f92672">-</span>lang F<span style="color:#f92672">#</span> <span style="color:#f92672">-</span>o CoCoTender.Storage
</span></span><span style="display:flex;"><span>dotnet add reference <span style="color:#f92672">../</span>CoCoTender.Domain
</span></span><span style="display:flex;"><span>cd <span style="color:#f92672">..</span>
</span></span><span style="display:flex;"><span>dotnet paket add LiteSharpDB.FSharp <span style="color:#f92672">-</span>p CoCoTender.Storage
</span></span><span style="display:flex;"><span>dotnet paket add FsToolkit.ErrorHandling <span style="color:#f92672">-</span>p CoCoTender.Storage
</span></span><span style="display:flex;"><span>dotnet sln add src<span style="color:#f92672">/</span>CoCoTender.Storage
</span></span></code></pre></div><p>We will organize the code such that</p>
<ul>
<li>Common type such as IStorageApi interface will be in CoCoTender.Storage namespace</li>
<li>Each type of storage will have it&rsquo;s own file and module. For example for LiteDB, we will create LiteDB.fs file with module CoCoTender.Storage.LiteDB.</li>
</ul>
<p>I think you can do that by yourself. Don&rsquo;t forget that all the new file should be include in the CoCoTender.Storage.fsproj with correct order. Common.fs should be at the top.</p>
<p>Now, we just need to add reference to Storage library in the Server file and open the module</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>cd src<span style="color:#f92672">/</span>Server
</span></span><span style="display:flex;"><span>dotnet add reference <span style="color:#f92672">../</span>CoCoTender.Storage
</span></span></code></pre></div><p>That&rsquo;s it for the simple persistence layer. You can get all the finished code by cloning tag v0.4.0.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-fsharp" data-lang="fsharp"><span style="display:flex;"><span>git clone <span style="color:#f92672">-</span>b v0<span style="color:#f92672">.</span>4<span style="color:#f92672">.</span>0 https<span style="color:#f92672">:</span><span style="color:#75715e">//github.com/twuttiwat/CoCoTender 
</span></span></span></code></pre></div><p>Good luck and see you at another post.</p>

      </div></div>

  

  
    

  
</article>

  </div>

  
    <footer class="footer">
  <div class="footer__inner">
    
      <div class="copyright">
        <span>Â© 2025 Powered by <a href="https://gohugo.io">Hugo</a></span>
    
      <span>:: <a href="https://github.com/panr/hugo-theme-terminal" target="_blank">Theme</a> made by <a href="https://github.com/panr" target="_blank">panr</a></span>
      </div>
  </div>
</footer>






<script type="text/javascript" src="/bundle.min.js"></script>





  
</div>

</body>
</html>
